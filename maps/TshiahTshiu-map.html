<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赤樹村環狀線 (綠色系拓撲圖)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* 1. 背景色：維持舊版的米白色 */
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f9f9f9; }
        #map { height: 100vh; width: 100vw; }
        
        /* 2. 返回按鈕 */
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background-color: #333; color: white; padding: 10px 20px; text-decoration: none;
            border-radius: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: background 0.3s;
        }
        .back-btn:hover { background-color: #555; }

        /* 3. 站點標籤 (綠色系) */
        .station-label-wrapper { background: transparent; border: none; }
        
        .station-label-content {
            /* 基礎樣式：白底、綠框、膠囊狀 */
            background-color: #fff;
            border: 2px solid #2e7d32; /* 深綠色邊框 */
            color: #333;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 14px; 
            font-weight: bold;
            white-space: nowrap; 
            width: max-content;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
            cursor: pointer;
            
            /* 絕對定位初始值，會透過 JS 動態修改 transform 來避免壓線 */
            position: absolute;
            left: 0; top: 0;
        }

        .station-label-content:hover {
            background-color: #e8f5e9; /* 滑鼠移過去變淺綠色 */
            z-index: 100;
        }
        
        /* Popup 樣式 */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content h3 { margin: 0 0 5px 0; color: #2e7d32; border-bottom: 2px solid #eee; padding-bottom: 5px;}
    </style>
</head>
<body>

<a href="../index.html" class="back-btn">⬅ 返回大地圖</a>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ==========================================
    // 1. 站點資料
    // ==========================================
    const stations = [
        { id: "tt1", name: "赤樹地鐵站", desc: "長途列車轉乘點。" },
        { id: "tt2", name: "赤樹牧場", desc: "牧場。" },
        { id: "tt3", name: "赤樹山頂", desc: "假日休閒好去處。" },
        { id: "tt4", name: "赤原", desc: "長途列車轉乘點。" },
        { id: "tt5", name: "赤樹村役所", desc: "赤樹村行政中心，辦理戶籍與觀光諮詢。" },
        { id: "tt6", name: "山後", desc: "可轉搭中沙便鐵。" },
        { id: "tt7", name: "建興", desc: "沙漠中的站點。" },
        { id: "tt8", name: "烏林", desc: "可轉乘中沙便鐵，或前往大田、大樹地區。" }
        
    ];

    // 設定圓形參數
    const centerX = 0;
    const centerY = 0;
    const radius = 220; // 軌道半徑
    const labelDistance = 45; // 標籤距離站點多遠 (像素)
    
    // ==========================================
    // 2. 自動計算座標與標籤位置
    // ==========================================
    
    // 從 -90度 (正上方 12點鐘) 開始
    const startAngle = -Math.PI / 2; 

    stations.forEach((s, index) => {
        // 計算角度
        const angle = startAngle + (index / stations.length) * (2 * Math.PI);
        
        // 1. 站點座標
        s.x = centerX + radius * Math.cos(angle);
        s.y = centerY + radius * Math.sin(angle);
        s.latLng = [-s.y, s.x];
        
        // 2. 標籤座標 (往外推 labelDistance)
        s.labelX = centerX + (radius + labelDistance) * Math.cos(angle);
        s.labelY = centerY + (radius + labelDistance) * Math.sin(angle);
        s.labelLatLng = [-s.labelY, s.labelX];

        // 3. ★關鍵：計算標籤的錨點方向 (解決壓線問題) ★
        // 我們將圓分成四個象限，根據角度決定 transform 的值
        // Leaflet 的 y 是負的，計算角度時要注意 (這裡使用純幾何角度判斷即可)
        // 角度範圍 0 ~ 2PI (或 -PI/2 ~ 3PI/2)
        
        let transformCSS = "";
        const deg = (angle * 180 / Math.PI) % 360; // 轉成角度方便思考
        
        // 正規化角度到 0~360
        let normDeg = deg;
        if (normDeg < 0) normDeg += 360;

        // 判斷邏輯：
        // 右側 (315度 ~ 45度): 靠左對齊 (translate 0, -50%)
        // 下側 (45度 ~ 135度): 向上對齊 (translate -50%, 0)
        // 左側 (135度 ~ 225度): 靠右對齊 (translate -100%, -50%)
        // 上側 (225度 ~ 315度): 向下對齊 (translate -50%, -100%)
        
        if (normDeg >= 330 || normDeg < 30) {
            // 右側 (3點鐘)：文字往右長
            transformCSS = "translate(10px, -50%)"; 
        } else if (normDeg >= 30 && normDeg < 150) {
            // 下側 (6點鐘)：文字置中，稍微往下
            transformCSS = "translate(-50%, 10px)";
        } else if (normDeg >= 150 && normDeg < 210) {
            // 左側 (9點鐘)：文字往左長
            transformCSS = "translate(calc(-100% - 10px), -50%)";
        } else {
            // 上側 (12點鐘)：文字置中，稍微往上
            transformCSS = "translate(-50%, calc(-100% - 10px))";
        }
        
        s.transformStyle = transformCSS;
    });

    // ==========================================
    // 3. 地圖繪製
    // ==========================================

    const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -2, maxZoom: 1, zoomSnap: 0.1, zoomControl: false, attributionControl: false
    });

    // (A) 繪製軌道
    const routeLatLngs = stations.map(s => s.latLng);
    routeLatLngs.push(routeLatLngs[0]); // 閉合圓圈

    // 外框 (深綠 #1b5e20)
    L.polyline(routeLatLngs, { color: '#1b5e20', weight: 14, lineCap: 'round', lineJoin: 'round' }).addTo(map);
    // 內線 (主綠 #4caf50)
    L.polyline(routeLatLngs, { color: '#4caf50', weight: 8, lineCap: 'round', lineJoin: 'round' }).addTo(map);

    // (B) 繪製站點與標籤
    stations.forEach(s => {
        // Popup
        const popupContent = `<h3>${s.name}</h3><p style="margin:5px 0; color:#333;">${s.desc}</p>`;

        // 圓點 (白底深綠框)
        const dot = L.circleMarker(s.latLng, {
            radius: 10,
            fillColor: "#fff",
            color: "#1b5e20",
            weight: 4,
            fillOpacity: 1
        }).addTo(map);
        dot.bindPopup(popupContent);

        // 標籤
        const label = L.marker(s.labelLatLng, {
            icon: L.divIcon({
                className: 'station-label-wrapper',
                // 將計算好的 transform 套用到 style
                html: `<div class="station-label-content" style="transform: ${s.transformStyle}">${s.name}</div>`,
                iconSize: [0, 0], iconAnchor: [0, 0]
            })
        }).addTo(map);
        
        label.on('click', () => dot.openPopup());
    });

    // 自動視野
    const bounds = L.latLngBounds(routeLatLngs).pad(0.4); // 稍微多留一點白邊給文字
    map.fitBounds(bounds);

</script>
</body>
</html>
