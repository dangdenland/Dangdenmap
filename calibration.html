<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ°åœ–ç²¾æº–æ ¡æº–å·¥å…· v6.0</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; }
        #controls { position: fixed; top: 10px; left: 10px; width: 320px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 1px solid #444; z-index: 1000; }
        #viewport { width: 100vw; height: 100vh; cursor: crosshair; position: relative; overflow: hidden; }
        #canvas-container { position: absolute; transform-origin: 0 0; }
        img { display: block; user-select: none; pointer-events: none; }
        .marker { position: absolute; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
        .m1 { background: #ff4444; box-shadow: 0 0 10px #ff4444; }
        .m2 { background: #4488ff; box-shadow: 0 0 10px #4488ff; }
        input { background: #333; color: #0f0; border: 1px solid #555; padding: 5px; width: 80px; }
        button { background: #28a745; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; margin-top: 10px; border-radius: 5px; font-weight: bold; }
        pre { background: #000; padding: 10px; font-size: 11px; color: #0f0; border: 1px dashed #555; white-space: pre-wrap; }
    </style>
</head>
<body>

<div id="controls">
    <h3>ğŸ—ºï¸ åœ°åœ–æ ¡æº– v6.0</h3>
    <input type="file" id="fileInput" accept="image/*" style="width:100%">
    <p style="font-size:12px; color:#aaa">1. è¼¸å…¥åŸºæº–é»éŠæˆ²åº§æ¨™ï¼š</p>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; font-size:12px">
        <span>P1(ç´…):</span><input type="number" id="p1x" value="6259"> <input type="number" id="p1y" value="-9041">
        <span>P2(è—):</span><input type="number" id="p2x" value="-1531"> <input type="number" id="p2y" value="-1010">
    </div>
    <div id="msg" style="color:yellow; margin:10px 0; font-weight:bold">è«‹è¼‰å…¥åœ°åœ–åœ–ç‰‡</div>
    <div id="result" style="display:none">
        <pre id="output"></pre>
        <button onclick="copyCode()">è¤‡è£½ä»£ç¢¼</button>
    </div>
    <button onclick="location.reload()" style="background:#666">é‡ç½®</button>
</div>

<div id="viewport">
    <div id="canvas-container">
        <img id="mapImg">
        <div id="markers"></div>
    </div>
</div>

<script>
    const state = { scale: 1, x: 0, y: 0, step: 1, imgW: 0, imgH: 0 };
    const p1 = { x: 0, y: 0 }, p2 = { x: 0, y: 0 };
    const container = document.getElementById('canvas-container');
    const img = document.getElementById('mapImg');

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            img.src = ev.target.result;
            img.onload = () => {
                state.imgW = img.naturalWidth; state.imgH = img.naturalHeight;
                document.getElementById('msg').innerText = "è«‹é»æ“Šç´…é»ä½ç½® (ç£å…§)";
                resetView();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function resetView() {
        state.scale = Math.min(window.innerWidth/state.imgW, window.innerHeight/state.imgH)*0.8;
        state.x = (window.innerWidth - state.imgW*state.scale)/2;
        state.y = (window.innerHeight - state.imgH*state.scale)/2;
        container.style.transform = `translate(${state.x}px,${state.y}px) scale(${state.scale})`;
    }

    document.getElementById('viewport').onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const mx = e.clientX, my = e.clientY;
        const ix = (mx - state.x)/state.scale, iy = (my - state.y)/state.scale;
        state.scale *= delta;
        state.x = mx - ix*state.scale; state.y = my - iy*state.scale;
        container.style.transform = `translate(${state.x}px,${state.y}px) scale(${state.scale})`;
    };

    let isDrag = false, sx, sy, moved = false;
    document.getElementById('viewport').onmousedown = (e) => { isDrag = true; sx = e.clientX; sy = e.clientY; moved = false; };
    window.onmousemove = (e) => { if(!isDrag) return; state.x += e.clientX-sx; state.y += e.clientY-sy; sx = e.clientX; sy = e.clientY; moved = true; container.style.transform = `translate(${state.x}px,${state.y}px) scale(${state.scale})`; };
    window.onmouseup = (e) => {
        if(!moved && isDrag && state.imgW > 0 && state.step <= 2) {
            const px = (e.clientX - state.x)/state.scale, py = (e.clientY - state.y)/state.scale;
            const dot = document.createElement('div');
            dot.className = 'marker m' + state.step; dot.style.left = px + 'px'; dot.style.top = py + 'px';
            document.getElementById('markers').appendChild(dot);
            if(state.step === 1) { p1.x = px; p1.y = py; state.step = 2; document.getElementById('msg').innerText = "è«‹é»æ“Šè—é»ä½ç½® (ä¸­æ¾³)"; }
            else { p2.x = px; p2.y = py; state.step = 3; calculate(); }
        }
        isDrag = false;
    };

    function calculate() {
        const g1 = { x: parseFloat(document.getElementById('p1x').value), y: parseFloat(document.getElementById('p1y').value) };
        const g2 = { x: parseFloat(document.getElementById('p2x').value), y: parseFloat(document.getElementById('p2y').value) };
        const sx = (g2.x - g1.x) / (p2.x - p1.x), sy = (g2.y - g1.y) / (p2.y - p1.y);
        const minX = g1.x - p1.x * sx, minY = g1.y - p1.y * sy;
        const code = `const mapSettings = {
    imageName: "map_bg.jpg",
    minX: ${Math.round(minX)},
    maxX: ${Math.round(minX + state.imgW * sx)},
    minY: ${Math.round(minY)},
    maxY: ${Math.round(minY + state.imgH * sy)}
};`;
        document.getElementById('output').innerText = code;
        document.getElementById('result').style.display = 'block';
        document.getElementById('msg').innerText = "âœ… æ ¡æº–å®Œæˆ";
    }

    function copyCode() { navigator.clipboard.writeText(document.getElementById('output').innerText); alert("ä»£ç¢¼å·²è¤‡è£½"); }
</script>
</body>
</html>
