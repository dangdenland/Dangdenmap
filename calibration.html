<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v4.0 (å½ˆæ€§éŒ¨é»ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; }
        #map { height: 100vh; width: 100vw; background-color: #333; }

        /* é¢æ¿æ¨£å¼ */
        #panel {
            position: fixed; top: 10px; right: 10px; z-index: 9999;
            background: rgba(0, 0, 0, 0.9); color: #fff; padding: 15px;
            border-radius: 8px; width: 340px; font-size: 14px;
            border: 1px solid #666; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 12px;
        }
        h2 { margin: 0; font-size: 18px; color: #ffcc00; border-bottom: 1px solid #555; padding-bottom: 8px; text-align: center; }
        
        .control-group { background: #2a2a2a; padding: 10px; border-radius: 4px; border: 1px solid #444; }
        .group-title { font-weight: bold; color: #4db8ff; margin-bottom: 8px; display: block; font-size: 13px; }
        
        .radio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; }
        .radio-label { 
            display: flex; align-items: center; justify-content: center;
            background: #444; padding: 6px; border-radius: 4px; cursor: pointer; border: 1px solid #555; font-size: 12px;
        }
        .radio-label:hover { background: #555; }
        .radio-label input { margin-right: 5px; }
        .radio-label.active { background: #007bff; border-color: #0056b3; color: white; }

        .desc { font-size: 12px; color: #ccc; line-height: 1.4; margin-top: 5px; }
        .key-hint { display: inline-block; padding: 1px 5px; background: #555; border-radius: 3px; font-family: monospace; color: #fff; border: 1px solid #777; font-size: 11px; }

        .btn-copy {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 5px;
        }
        .btn-copy:hover { background-color: #218838; }
        
        /* è®“åœ“é»æ›´æ˜é¡¯ */
        .leaflet-marker-icon { opacity: 0.9 !important; border: 1px solid white; border-radius: 50%; }
        
        /* æ•¸å€¼é¡¯ç¤º */
        .debug-info { font-family: monospace; font-size: 10px; color: #666; text-align: center; margin-top: 5px;}
    </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h2>ğŸ› ï¸ åœ°åœ–æ ¡æ­£ v4.0 (å½ˆæ€§éŒ¨é»)</h2>

    <!-- æ­¥é©Ÿ 1: é¸æ“‡éŒ¨é» -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 1: æ‚¨æƒ³é–å®šå“ªè£¡çš„æ‘èŠ?</span>
        <div class="radio-group">
            <label class="radio-label" onclick="setAnchor('tl')">
                <input type="radio" name="anchor" value="tl"> â†–ï¸ å·¦ä¸Š
            </label>
            <label class="radio-label active" onclick="setAnchor('tr')">
                <input type="radio" name="anchor" value="tr" checked> â†—ï¸ å³ä¸Š
            </label>
            <label class="radio-label" onclick="setAnchor('bl')">
                <input type="radio" name="anchor" value="bl"> â†™ï¸ å·¦ä¸‹
            </label>
            <label class="radio-label" onclick="setAnchor('br')">
                <input type="radio" name="anchor" value="br"> â†˜ï¸ å³ä¸‹
            </label>
        </div>
        <div class="desc" id="anchor-desc">ç›®å‰é–å®šï¼š<b>â†—ï¸ å³ä¸Šè§’</b><br>æ‹‰ä¼¸æ™‚ï¼Œå³ä¸Šè§’ä¸æœƒå‹•ï¼Œåªå‹•å·¦ä¸‹ã€‚</div>
    </div>

    <!-- æ­¥é©Ÿ 2: å¹³ç§» -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 2: å¹³ç§»å°é½Š (WASD)</span>
        <div class="desc">
            ä½¿ç”¨ <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> ç§»å‹•æ•´å¼µåœ–ã€‚<br>
            <span style="color:#ff6b6b">ç›®æ¨™ï¼šå°‡æ‚¨é¸å®šè§’è½çš„æ‘èŠå°é½Šåœ“é»ã€‚</span>
        </div>
    </div>

    <!-- æ­¥é©Ÿ 3: æ‹‰ä¼¸ -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 3: æ‹‰ä¼¸å°è§’ (æ–¹å‘éµ)</span>
        <div class="desc">
            ä½¿ç”¨ <span class="key-hint">â¬†ï¸</span> <span class="key-hint">â¬‡ï¸</span> <span class="key-hint">â¬…ï¸</span> <span class="key-hint">â¡ï¸</span> æ‹‰ä¼¸ã€‚<br>
            <span style="color:#4db8ff">ç›®æ¨™ï¼šå°‡<b>å°è§’ç·š</b>çš„æ‘èŠä¹Ÿå°é½Šã€‚</span>
        </div>
    </div>

    <!-- é€Ÿåº¦æ§åˆ¶ -->
    <div class="control-group" style="padding: 5px 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:12px;">å¾®èª¿é€Ÿåº¦</span>
            <span style="font-size:12px; font-family:monospace;" id="speedVal">20 px</span>
        </div>
        <input type="range" id="speedRange" min="1" max="100" value="20" style="width:100%">
    </div>

    <button class="btn-copy" onclick="copyConfig()">âœ… å®Œæˆï¼è¤‡è£½ä»£ç¢¼</button>
    <div class="debug-info" id="debug-coords"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    if (typeof mapSettings === 'undefined') {
        var mapSettings = { imageName: "map_bg.png", minX: -2560, maxX: 9359, minY: -9728, maxY: 1023 };
    }

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 2, zoomSnap: 0.1, attributionControl: false, zoomControl: false
    });
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // ç¹ªè£½æ‘èŠåƒè€ƒé»
    const bounds = [];
    if (typeof rawData !== 'undefined') {
        rawData.forEach(v => {
            const latLng = [-v.y, v.x];
            bounds.push(latLng);
            L.circleMarker(latLng, {
                radius: 4, color: '#fff', weight:1, fillColor: '#ff0000', fillOpacity: 0.8
            }).bindTooltip(v.name, {permanent: true, direction: 'auto', opacity:0.7}).addTo(map);
        });
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [100, 100] });
    }

    // ç•¶å‰æ•¸å€¼
    let current = {
        minX: mapSettings.minX, maxX: mapSettings.maxX,
        minY: mapSettings.minY, maxY: mapSettings.maxY
    };

    // ç•¶å‰é–å®šçš„éŒ¨é» (é è¨­å³ä¸Š tr)
    let currentAnchor = 'tr'; 

    // å»ºç«‹åº•åœ–
    let mapImageLayer = L.imageOverlay(
        mapSettings.imageName, 
        [[-current.minY, current.minX], [-current.maxY, current.maxX]], 
        { opacity: 0.6, zIndex: -1 }
    );
    mapImageLayer.addTo(map);

    function render() {
        mapImageLayer.setBounds([[-current.minY, current.minX], [-current.maxY, current.maxX]]);
        document.getElementById('debug-coords').innerText = `X: ${Math.round(current.minX)} ~ ${Math.round(current.maxX)} | Y: ${Math.round(current.minY)} ~ ${Math.round(current.maxY)}`;
    }

    // åˆ‡æ›éŒ¨é» UI é‚è¼¯
    window.setAnchor = function(val) {
        currentAnchor = val;
        // æ›´æ–° UI æ¨£å¼
        document.querySelectorAll('.radio-label').forEach(el => el.classList.remove('active'));
        document.querySelector(`input[value="${val}"]`).parentElement.classList.add('active');
        
        // æ›´æ–°èªªæ˜æ–‡å­—
        const descMap = {
            'tl': 'ç›®å‰é–å®šï¼š<b>â†–ï¸ å·¦ä¸Šè§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå³å´ã€èˆ‡ã€Œä¸‹æ–¹ã€ã€‚',
            'tr': 'ç›®å‰é–å®šï¼š<b>â†—ï¸ å³ä¸Šè§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå·¦å´ã€èˆ‡ã€Œä¸‹æ–¹ã€ã€‚',
            'bl': 'ç›®å‰é–å®šï¼š<b>â†™ï¸ å·¦ä¸‹è§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå³å´ã€èˆ‡ã€Œä¸Šæ–¹ã€ã€‚',
            'br': 'ç›®å‰é–å®šï¼š<b>â†˜ï¸ å³ä¸‹è§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå·¦å´ã€èˆ‡ã€Œä¸Šæ–¹ã€ã€‚'
        };
        document.getElementById('anchor-desc').innerHTML = descMap[val];
    }
    
    // åˆå§‹åŒ– UI
    setAnchor('tr');

    // éµç›¤æ§åˆ¶æ ¸å¿ƒé‚è¼¯
    document.addEventListener('keydown', (e) => {
        let step = parseInt(document.getElementById('speedRange').value);
        if (e.shiftKey) step *= 5; 

        // 1. WASD å¹³ç§» (æ‰€æœ‰é‚Šç•ŒåŒæ™‚ç§»å‹•)
        if (['KeyW','KeyS','KeyA','KeyD'].includes(e.code)) {
            if (e.code === 'KeyW') { current.minY -= step; current.maxY -= step; } // ä¸Š
            if (e.code === 'KeyS') { current.minY += step; current.maxY += step; } // ä¸‹
            if (e.code === 'KeyA') { current.minX -= step; current.maxX -= step; } // å·¦
            if (e.code === 'KeyD') { current.minX += step; current.maxX += step; } // å³
            render();
            return;
        }

        // 2. æ–¹å‘éµ æ‹‰ä¼¸ (æ ¹æ“šéŒ¨é»æ±ºå®šå‹•å“ªå€‹é‚Š)
        if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) {
            e.preventDefault(); // é˜²æ­¢æ²å‹•ç¶²é 

            // å‚ç›´æ‹‰ä¼¸é‚è¼¯
            if (e.code === 'ArrowUp' || e.code === 'ArrowDown') {
                const isExpand = (e.code === 'ArrowDown'); // ä¸‹éµä»£è¡¨ã€Œè®Šé«˜/è®Šé•·ã€
                const delta = isExpand ? step : -step;

                // å¦‚æœé–å®šä¸Šæ–¹ (Top Locked)ï¼Œå‹•ä¸‹æ–¹ (MaxY)
                if (currentAnchor === 'tl' || currentAnchor === 'tr') {
                    current.maxY += delta;
                } 
                // å¦‚æœé–å®šä¸‹æ–¹ (Bottom Locked)ï¼Œå‹•ä¸Šæ–¹ (MinY)
                else {
                    current.minY -= delta; // å¾€ä¸Šé•·æ˜¯æ¸›
                }
            }

            // æ°´å¹³æ‹‰ä¼¸é‚è¼¯
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
                const isExpand = (e.code === 'ArrowRight'); // å³éµä»£è¡¨ã€Œè®Šå¯¬/è®Šé•·ã€
                const delta = isExpand ? step : -step;

                // å¦‚æœé–å®šå·¦æ–¹ (Left Locked)ï¼Œå‹•å³æ–¹ (MaxX)
                if (currentAnchor === 'tl' || currentAnchor === 'bl') {
                    current.maxX += delta;
                } 
                // å¦‚æœé–å®šå³æ–¹ (Right Locked)ï¼Œå‹•å·¦æ–¹ (MinX)
                else {
                    current.minX -= delta;
                }
            }
            render();
        }
    });

    document.getElementById('speedRange').addEventListener('input', (e) => {
        document.getElementById('speedVal').innerText = e.target.value + " px";
    });

    window.copyConfig = function() {
        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v4 æ ¡æ­£å®Œæˆ)
// ==========================================
const mapSettings = {
    imageName: "${mapSettings.imageName}",
    minX: ${Math.round(current.minX)},
    maxX: ${Math.round(current.maxX)},
    minY: ${Math.round(current.minY)},
    maxY: ${Math.round(current.maxY)}
};`;
        navigator.clipboard.writeText(code).then(() => alert("âœ… ä»£ç¢¼å·²è¤‡è£½ï¼")).catch(() => console.log(code));
    }
</script>

</body>
</html>
