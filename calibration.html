<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v5.2 (æ¥µç°¡é™¤éŒ¯ç‰ˆ)</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; }
        
        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: fixed; top: 10px; right: 10px; width: 300px;
            background: rgba(0,0,0,0.9); border: 2px solid #ffcc00;
            padding: 15px; border-radius: 8px; z-index: 9999;
        }
        
        /* åœ–ç‰‡å®¹å™¨ */
        #map-container {
            margin-top: 50px;
            border: 2px solid red; /* ç´…æ¡†è®“ä½ çŸ¥é“å®¹å™¨åœ¨å“ª */
            min-height: 500px;
            overflow: auto; /* è¶…å‡ºç¯„åœæœƒå‡ºç¾æ²è»¸ */
            position: relative;
            background: #444;
            cursor: crosshair;
        }

        /* åœ–ç‰‡æœ¬é«” */
        #target-img {
            display: block;
            max-width: 100%; /* å¼·åˆ¶ç¸®å°ä»¥é©æ‡‰è¢å¹• */
            height: auto;
        }

        button { padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-green { background: #28a745; color: white; border: none; }
        .btn-blue { background: #007bff; color: white; border: none; }
        
        #status-log { color: yellow; font-family: monospace; margin-top: 10px; font-size: 12px; white-space: pre-wrap; }

        /* æ¨™è¨˜é» */
        .marker {
            position: absolute; width: 10px; height: 10px; background: red;
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .marker.p2 { background: blue; }
    </style>
</head>
<body>

<!-- æ§åˆ¶å€ -->
<div id="controls">
    <h3>ğŸ› ï¸ æ ¡æ­£å·¥å…· v5.2</h3>
    <p style="font-size:12px; color:#ccc;">å¦‚æœåœ–ç‰‡å¤ªå¤§ï¼Œè«‹ç¨ç­‰å¹¾ç§’ã€‚</p>
    
    <input type="file" id="fileInput" accept="image/*" onchange="loadFile(this)">
    
    <div id="instruction" style="margin: 10px 0; font-weight:bold; color: #4db8ff;">
        æ­¥é©Ÿ 1: è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”æ¡ˆ
    </div>

    <button id="copyBtn" class="btn-green" style="display:none;" onclick="copyCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
    
    <div id="status-log">ç­‰å¾…æ“ä½œ...</div>
</div>

<!-- åœ–ç‰‡é¡¯ç¤ºå€ -->
<div id="map-container">
    <div id="click-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index: 10;"></div>
    <img id="target-img" alt="è«‹è¼‰å…¥åœ–ç‰‡" />
</div>

<script>
    // ============================
    // 1. å¯«æ­»åŸºæº–é» (é€™æ˜¯æœ€æº–çš„)
    // ============================
    const pointA = { name: "ç£å…§", gameX: 6259, gameY: -9041 };
    const pointB = { name: "ä¸­æ¾³", gameX: -1531, gameY: -1010 };

    // è®Šæ•¸
    let step = 0;
    let imgNaturalWidth = 0;
    let imgNaturalHeight = 0;
    let p1_pixel = null;
    let p2_pixel = null;

    const logEl = document.getElementById('status-log');
    const imgEl = document.getElementById('target-img');
    const container = document.getElementById('map-container');
    const instruct = document.getElementById('instruction');

    function log(msg) {
        logEl.innerText += "\n" + msg;
        console.log(msg);
    }

    // 2. æª”æ¡ˆè®€å–åŠŸèƒ½
    function loadFile(input) {
        if (input.files && input.files[0]) {
            log("æ­£åœ¨è®€å–æª”æ¡ˆ...");
            const reader = new FileReader();
            
            reader.onload = function(e) {
                log("æª”æ¡ˆè®€å–å®Œæˆï¼Œæ­£åœ¨é¡¯ç¤º...");
                imgEl.src = e.target.result; // è¨­å®šåœ–ç‰‡
                
                imgEl.onload = function() {
                    imgNaturalWidth = this.naturalWidth;
                    imgNaturalHeight = this.naturalHeight;
                    log(`åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼å°ºå¯¸: ${imgNaturalWidth} x ${imgNaturalHeight}`);
                    
                    // é‡ç½®æ­¥é©Ÿ
                    step = 1;
                    p1_pixel = null;
                    p2_pixel = null;
                    // æ¸…é™¤èˆŠæ¨™è¨˜
                    document.querySelectorAll('.marker').forEach(e => e.remove());
                    
                    instruct.innerText = "æ­¥é©Ÿ 2: è«‹é»æ“Šåœ–ä¸Šçš„ã€Œç£å…§ã€(å³ä¸Š)";
                    instruct.style.color = "#ff4444"; // ç´…è‰²æç¤º
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. é»æ“Šåµæ¸¬ (ç›´æ¥ç¶åœ¨åœ–ç‰‡ä¸Š)
    imgEl.addEventListener('click', function(e) {
        if (step === 0) return;

        // å–å¾—é»æ“Šä½ç½®ç›¸å°æ–¼åœ–ç‰‡çš„åº§æ¨™
        // ç”±æ–¼åœ–ç‰‡å¯èƒ½è¢« CSS ç¸®æ”¾ (max-width: 100%)ï¼Œæˆ‘å€‘éœ€è¦æ›ç®—å›åŸå§‹åƒç´ 
        const rect = imgEl.getBoundingClientRect();
        
        // é»æ“Šä½ç½®åœ¨åœ–ç‰‡å…ƒç´ å…§çš„ X, Y
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        // ç¸®æ”¾æ¯”ä¾‹ (é¡¯ç¤ºå¤§å° / åŸå§‹å¤§å°)
        const scaleX = imgEl.width / imgNaturalWidth;
        const scaleY = imgEl.height / imgNaturalHeight;

        // æ›ç®—å›åŸå§‹åƒç´ 
        const realX = clickX / scaleX;
        const realY = clickY / scaleY;

        log(`é»æ“Šåº§æ¨™: ${Math.round(realX)}, ${Math.round(realY)}`);
        
        // æ¨™è¨˜ç´…é» (è¦–è¦ºå›é¥‹)
        // æ³¨æ„ï¼šé€™è£¡çš„ç´…é»æ˜¯è²¼åœ¨ map-container ä¸Šï¼Œä½ç½®è¦ç”¨ pageX/pageY å°æ‡‰
        const marker = document.createElement('div');
        marker.className = step === 1 ? 'marker' : 'marker p2';
        // ç‚ºäº†è®“æ¨™è¨˜è·Ÿè‘—åœ–ç‰‡è·‘ï¼Œæˆ‘å€‘æŠŠå®ƒ append åˆ° containerï¼Œä¸¦ä½¿ç”¨ç›¸å°å®šä½
        // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œç›´æ¥ç”¨çµ•å°å®šä½è²¼åœ¨é»æ“Šè™•
        marker.style.left = (e.pageX - container.offsetLeft + container.scrollLeft) + 'px';
        marker.style.top = (e.pageY - container.offsetTop + container.scrollTop) + 'px';
        // ä¿®æ­£ï¼šä¸Šé¢çš„ç®—æ³•åœ¨æœ‰ scroll æ™‚æœƒè·‘æ‰ï¼Œç›´æ¥ç”¨ clientX é…åˆ fixed 
        // æˆ–æ˜¯æœ€ç°¡å–®çš„ï¼šç›´æ¥ç®— style.left = e.offsetX ... 
        // é€™è£¡ç‚ºäº†é™¤éŒ¯ç‰ˆç°¡å–®åŒ–ï¼Œæˆ‘å€‘ç›´æ¥è²¼åœ¨ body ä¸Š
        marker.style.position = 'fixed';
        marker.style.left = e.clientX + 'px';
        marker.style.top = e.clientY + 'px';
        document.body.appendChild(marker);

        if (step === 1) {
            p1_pixel = { x: realX, y: realY };
            step = 2;
            instruct.innerText = "æ­¥é©Ÿ 3: è«‹é»æ“Šåœ–ä¸Šçš„ã€Œä¸­æ¾³ã€(å·¦ä¸‹)";
            instruct.style.color = "#4444ff"; // è—è‰²æç¤º
        } else if (step === 2) {
            p2_pixel = { x: realX, y: realY };
            step = 3;
            instruct.innerText = "è¨ˆç®—å®Œæˆï¼è«‹è¤‡è£½ä»£ç¢¼";
            document.getElementById('copyBtn').style.display = 'block';
            calculate();
        }
    });

    // 4. è¨ˆç®—èˆ‡è¼¸å‡º
    function calculate() {
        // éŠæˆ²åº§æ¨™å·® / åƒç´ åº§æ¨™å·® = æ¯åƒç´ ä»£è¡¨å¤šå°‘éŠæˆ²å–®ä½
        const scaleX = (pointB.gameX - pointA.gameX) / (p2_pixel.x - p1_pixel.x);
        const scaleY = (pointB.gameY - pointA.gameY) / (p2_pixel.y - p1_pixel.y);

        // æ¨ç®—å·¦ä¸Šè§’ (0,0) çš„éŠæˆ²åº§æ¨™
        const minX = pointA.gameX - (p1_pixel.x * scaleX);
        const minY = pointA.gameY - (p1_pixel.y * scaleY);

        // æ¨ç®—å³ä¸‹è§’
        const maxX = minX + (imgNaturalWidth * scaleX);
        const maxY = minY + (imgNaturalHeight * scaleY);

        const fileName = document.getElementById('fileInput').files[0].name;

        window.resultCode = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v5.2 é€†å‘æ ¡æ­£)
// ==========================================
const mapSettings = {
    imageName: "${fileName}",
    
    minX: ${Math.round(minX)},
    maxX: ${Math.round(maxX)},
    minY: ${Math.round(minY)},
    maxY: ${Math.round(maxY)}
};`;
        log("è¨ˆç®—çµæœ:\n" + window.resultCode);
    }

    function copyCode() {
        navigator.clipboard.writeText(window.resultCode).then(() => {
            alert("âœ… å·²è¤‡è£½ï¼è«‹è¦†è“‹ config.js");
        });
    }
</script>

</body>
</html>
