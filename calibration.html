<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; background-color: #f5f5f5; }

        /* æ ¡æ­£é¢æ¿æ¨£å¼ */
        #calibration-panel {
            position: fixed; bottom: 20px; left: 20px; z-index: 9999;
            background: rgba(0, 0, 0, 0.85); color: #fff; padding: 15px;
            border-radius: 8px; width: 300px; font-size: 13px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #555;
            display: flex; flex-direction: column; gap: 10px;
        }
        #calibration-panel h2 { margin: 0; font-size: 16px; color: #ffcc00; border-bottom: 1px solid #666; padding-bottom: 8px; text-align: center; }
        
        .section { background: #333; padding: 8px; border-radius: 4px; }
        .section-title { font-size: 11px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .cal-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .cal-row label { flex: 1; font-size: 12px; }
        .cal-row input { width: 80px; padding: 2px 4px; text-align: right; background: #222; color: #fff; border: 1px solid #555; font-family: monospace; }

        /* åå­—ç§»å‹•éµæ¨£å¼ */
        .move-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; width: 120px; margin: 0 auto; }
        .move-btn { background: #444; border: 1px solid #666; color: white; padding: 8px 0; cursor: pointer; border-radius: 4px; text-align: center; }
        .move-btn:hover { background: #666; }
        .move-btn:active { background: #888; }
        .move-center { grid-column: 2; }
        
        .step-control { display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; }
        .step-control input { width: 50px; text-align: center; background: #222; color: #fff; border: 1px solid #555; }

        .action-btn {
            width: 100%; padding: 10px; margin-top: 5px;
            background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .action-btn:hover { background-color: #218838; }
        
        .hint { font-size: 11px; color: #aaa; line-height: 1.4; text-align: center; }
        
        .leaflet-marker-icon, .leaflet-interactive { opacity: 0.8 !important; }
    </style>
</head>
<body>

<div id="map"></div>

<!-- æ ¡æ­£é¢æ¿ -->
<div id="calibration-panel">
    <h2>ğŸ› ï¸ åœ°åœ–åº•åœ–æ ¡æ­£å™¨</h2>
    
    <!-- å¹³ç§»æ§åˆ¶å€ -->
    <div class="section">
        <div class="section-title">å¹³ç§»æ•´å¼µåœ°åœ– (ç§»å‹•)</div>
        <div class="move-controls">
            <!-- ä¸Š -->
            <button class="move-btn move-center" onclick="moveMap(0, -1)">â¬†ï¸</button>
            <!-- å·¦/å³ -->
            <button class="move-btn" onclick="moveMap(-1, 0)">â¬…ï¸</button>
            <div style="text-align:center; line-height: 30px; font-size:20px;">Move</div>
            <button class="move-btn" onclick="moveMap(1, 0)">â¡ï¸</button>
            <!-- ä¸‹ -->
            <button class="move-btn move-center" onclick="moveMap(0, 1)">â¬‡ï¸</button>
        </div>
        <div class="step-control">
            <label>ç§»å‹•é€Ÿåº¦:</label>
            <input type="number" id="step-size" value="50" min="1">
        </div>
    </div>

    <!-- é‚Šç•Œæ•¸å€¼å€ -->
    <div class="section">
        <div class="section-title">é‚Šç•Œå¾®èª¿ (ä¼¸ç¸®/è£åˆ‡)</div>
        <div class="cal-row"><label>ä¸Š (Y Min):</label><input type="number" id="in-minY"></div>
        <div class="cal-row"><label>ä¸‹ (Y Max):</label><input type="number" id="in-maxY"></div>
        <div class="cal-row"><label>å·¦ (X Min):</label><input type="number" id="in-minX"></div>
        <div class="cal-row"><label>å³ (X Max):</label><input type="number" id="in-maxX"></div>
    </div>

    <button class="action-btn" onclick="copyConfig()">ğŸ“‹ è¤‡è£½è¨­å®šç¢¼</button>
    <div class="hint">è²¼å› config.js è¦†è“‹å³å¯</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- å¼•å…¥è¨­å®šæª”èˆ‡è³‡æ–™æª” -->
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    if (typeof mapSettings === 'undefined' || typeof rawData === 'undefined') {
        alert("æ‰¾ä¸åˆ° config.js æˆ– data.jsï¼Œè«‹ç¢ºèªæª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚");
    }

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -6, maxZoom: 3, zoomSnap: 0.5,
        attributionControl: false
    });

    // ç¹ªè£½åƒè€ƒç´…é»
    const bounds = [];
    rawData.forEach(v => {
        const latLng = [-v.y, v.x];
        bounds.push(latLng);
        L.circleMarker(latLng, {
            radius: 4, color: 'red', fillColor: '#f00', fillOpacity: 0.8, weight: 1
        }).bindTooltip(v.name, {permanent: true, direction: 'top', className: 'cal-label'}).addTo(map);
    });

    if (bounds.length > 0) map.fitBounds(bounds, { padding: [100, 100] });

    // ==========================================
    // æ ¡æ­£é‚è¼¯
    // ==========================================
    
    // ç•¶å‰æ•¸å€¼ç‹€æ…‹
    let current = {
        minY: mapSettings.minY,
        maxY: mapSettings.maxY,
        minX: mapSettings.minX,
        maxX: mapSettings.maxX
    };

    const inMinY = document.getElementById('in-minY');
    const inMaxY = document.getElementById('in-maxY');
    const inMinX = document.getElementById('in-minX');
    const inMaxX = document.getElementById('in-maxX');
    const stepInput = document.getElementById('step-size');

    // ä»‹é¢æ›´æ–°å‡½æ•¸
    function updateInputs() {
        inMinY.value = current.minY;
        inMaxY.value = current.maxY;
        inMinX.value = current.minX;
        inMaxX.value = current.maxX;
    }

    // åˆå§‹åŒ–è¼¸å…¥æ¡†
    updateInputs();

    // å»ºç«‹åº•åœ–
    let mapImageLayer = L.imageOverlay(
        mapSettings.imageName, 
        [[-current.minY, current.minX], [-current.maxY, current.maxX]], 
        { opacity: 0.65, zIndex: -1 }
    );
    mapImageLayer.addTo(map);

    // æ›´æ–°åœ°åœ–å‡½æ•¸
    function renderMap() {
        mapImageLayer.setBounds([
            [-current.minY, current.minX], 
            [-current.maxY, current.maxX]
        ]);
    }

    // --- åŠŸèƒ½ 1: å¹³ç§» (Move) ---
    // dirX: -1(å·¦), 1(å³), 0
    // dirY: -1(ä¸Š), 1(ä¸‹), 0
    window.moveMap = function(dirX, dirY) {
        const step = parseFloat(stepInput.value) || 50;
        
        // æ›´æ–° X (å·¦å³å¹³ç§»)
        if (dirX !== 0) {
            current.minX += (dirX * step);
            current.maxX += (dirX * step);
        }

        // æ›´æ–° Y (ä¸Šä¸‹å¹³ç§»)
        // æ³¨æ„ï¼šéŠæˆ²åº§æ¨™ Y è¶Šå°è¶Šä¸Šé¢ (minY)ï¼ŒY è¶Šå¤§è¶Šä¸‹é¢ (maxY)
        // ç•¶æˆ‘å€‘æŒ‰ã€Œä¸Šã€æ™‚ï¼Œè¦–è¦ºä¸Šåœ–ç‰‡è¦å¾€ä¸Šè·‘ => Lat è®Šå¤§ => -GameY è®Šå¤§ => GameY è®Šå°
        // æ‰€ä»¥æŒ‰ä¸Š (-1) æ‡‰è©²è¦æ¸›å» step
        if (dirY !== 0) {
            current.minY += (dirY * step);
            current.maxY += (dirY * step);
        }

        updateInputs();
        renderMap();
    }

    // --- åŠŸèƒ½ 2: æ‰‹å‹•è¼¸å…¥ (Resize) ---
    function onManualInput() {
        current.minY = parseFloat(inMinY.value);
        current.maxY = parseFloat(inMaxY.value);
        current.minX = parseFloat(inMinX.value);
        current.maxX = parseFloat(inMaxX.value);
        renderMap();
    }

    [inMinY, inMaxY, inMinX, inMaxX].forEach(el => {
        el.addEventListener('input', onManualInput);
    });

    // --- åŠŸèƒ½ 3: è¤‡è£½è¨­å®š ---
    window.copyConfig = function() {
        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª”
// ==========================================

const mapSettings = {
    imageName: "${mapSettings.imageName}",

    // å·¦é‚Šç•Œ (X Min)
    minX: ${current.minX},
    
    // å³é‚Šç•Œ (X Max)
    maxX: ${current.maxX},
    
    // ä¸Šé‚Šç•Œ (Y Min)
    minY: ${current.minY},
    
    // ä¸‹é‚Šç•Œ (Y Max)
    maxY: ${current.maxY}
};`;

        navigator.clipboard.writeText(code).then(() => {
            alert("âœ… è¨­å®šç¢¼å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ config.js ä¸¦è²¼ä¸Šè¦†è“‹ã€‚");
        }).catch(() => {
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ Console å…§å®¹");
            console.log(code);
        });
    }

</script>

</body>
</html>
