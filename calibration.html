<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· (é–‹ç™¼è€…å°ˆç”¨)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; background-color: #f5f5f5; }

        /* æ ¡æ­£é¢æ¿æ¨£å¼ */
        #calibration-panel {
            position: fixed; bottom: 20px; left: 20px; z-index: 9999;
            background: rgba(0, 0, 0, 0.85); color: #fff; padding: 20px;
            border-radius: 8px; width: 280px; font-size: 13px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #555;
        }
        #calibration-panel h2 { margin: 0 0 15px 0; font-size: 16px; color: #ffcc00; border-bottom: 1px solid #666; padding-bottom: 8px; }
        .cal-row { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .cal-row label { flex: 1; }
        .cal-row input { width: 90px; padding: 4px; text-align: right; background: #333; color: #fff; border: 1px solid #555; }
        
        button {
            width: 100%; padding: 10px; margin-top: 15px;
            background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        button:hover { background-color: #218838; }
        
        .hint { margin-top: 10px; font-size: 11px; color: #aaa; line-height: 1.4; }
        
        /* è®“æ¨™è¨˜é»ç¨å¾®é€æ˜ï¼Œæ–¹ä¾¿çœ‹åº•åœ– */
        .leaflet-marker-icon, .leaflet-interactive { opacity: 0.8 !important; }
    </style>
</head>
<body>

<div id="map"></div>

<!-- æ ¡æ­£é¢æ¿ -->
<div id="calibration-panel">
    <h2>ğŸ› ï¸ åœ°åœ–åº•åœ–æ ¡æ­£å™¨</h2>
    
    <div class="cal-row">
        <label>ä¸Šé‚Šç•Œ (Y Min):</label>
        <input type="number" id="in-minY" step="50">
    </div>
    <div class="cal-row">
        <label>ä¸‹é‚Šç•Œ (Y Max):</label>
        <input type="number" id="in-maxY" step="50">
    </div>
    <div class="cal-row">
        <label>å·¦é‚Šç•Œ (X Min):</label>
        <input type="number" id="in-minX" step="50">
    </div>
    <div class="cal-row">
        <label>å³é‚Šç•Œ (X Max):</label>
        <input type="number" id="in-maxX" step="50">
    </div>

    <button onclick="copyConfig()">ğŸ“‹ è¤‡è£½è¨­å®šç¢¼</button>
    
    <div class="hint">
        1. èª¿æ•´æ•¸å€¼ç›´åˆ°åœ“é»èˆ‡åœ°åœ–å°é½Šã€‚<br>
        2. é»æ“ŠæŒ‰éˆ•è¤‡è£½ä»£ç¢¼ã€‚<br>
        3. è²¼å› <b>config.js</b> è¦†è“‹åŸæœ¬å…§å®¹ã€‚
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- å¼•å…¥æ‚¨çš„è¨­å®šæª”èˆ‡è³‡æ–™æª” -->
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    // æª¢æŸ¥æª”æ¡ˆ
    if (typeof mapSettings === 'undefined' || typeof rawData === 'undefined') {
        alert("æ‰¾ä¸åˆ° config.js æˆ– data.jsï¼Œè«‹ç¢ºèªæª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚");
    }

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -6, maxZoom: 3, zoomSnap: 0.5,
        attributionControl: false
    });

    // ç¹ªè£½æ‘èŠé» (ä½œç‚ºæ ¡æ­£åŸºæº–)
    // é€™è£¡æˆ‘å€‘åªç•«ç°¡å–®çš„ç´…é»ï¼Œæ–¹ä¾¿å°ä½
    const bounds = [];
    rawData.forEach(v => {
        const latLng = [-v.y, v.x];
        bounds.push(latLng);
        L.circleMarker(latLng, {
            radius: 4, 
            color: 'red', fillColor: '#f00', fillOpacity: 0.8, weight: 1
        }).bindTooltip(v.name, {permanent: true, direction: 'top', className: 'cal-label'}).addTo(map);
    });

    if (bounds.length > 0) map.fitBounds(bounds, { padding: [100, 100] });

    // ==========================================
    // æ ¡æ­£é‚è¼¯
    // ==========================================
    
    // 1. è®€å– config.js çš„åˆå§‹å€¼
    let currentSettings = { ...mapSettings }; // è¤‡è£½ä¸€ä»½
    
    const inputMinY = document.getElementById('in-minY');
    const inputMaxY = document.getElementById('in-maxY');
    const inputMinX = document.getElementById('in-minX');
    const inputMaxX = document.getElementById('in-maxX');

    // å¡«å…¥é¢æ¿
    inputMinY.value = currentSettings.minY;
    inputMaxY.value = currentSettings.maxY;
    inputMinX.value = currentSettings.minX;
    inputMaxX.value = currentSettings.maxX;

    // 2. å»ºç«‹åº•åœ–åœ–å±¤
    let mapImageLayer = L.imageOverlay(
        currentSettings.imageName, 
        [
            [-currentSettings.minY, currentSettings.minX], 
            [-currentSettings.maxY, currentSettings.maxX]
        ], 
        { opacity: 0.7, zIndex: -1 } // åŠé€æ˜æ–¹ä¾¿å°ä½
    );
    mapImageLayer.addTo(map);

    // 3. æ›´æ–°å‡½æ•¸
    function updateMap() {
        // å–å¾—è¼¸å…¥æ¡†æ•¸å€¼
        const minY = parseFloat(inputMinY.value);
        const maxY = parseFloat(inputMaxY.value);
        const minX = parseFloat(inputMinX.value);
        const maxX = parseFloat(inputMaxX.value);

        // æ›´æ–°åœ–å±¤ä½ç½® (æ³¨æ„ Y è»¸ç¿»è½‰)
        // TopLeft: [-minY, minX]
        // BottomRight: [-maxY, maxX]
        mapImageLayer.setBounds([
            [-minY, minX], 
            [-maxY, maxX]
        ]);
    }

    // ç›£è½è¼¸å…¥äº‹ä»¶
    [inputMinY, inputMaxY, inputMinX, inputMaxX].forEach(input => {
        input.addEventListener('input', updateMap);
    });

    // 4. è¤‡è£½åŠŸèƒ½
    function copyConfig() {
        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (æ¯æ¬¡æ›åœ–åªè¦æ”¹é€™è£¡)
// ==========================================

const mapSettings = {
    imageName: "${currentSettings.imageName}",

    // å·¦é‚Šç•Œ (X Min)
    minX: ${inputMinX.value},
    
    // å³é‚Šç•Œ (X Max)
    maxX: ${inputMaxX.value},
    
    // ä¸Šé‚Šç•Œ (Y Min)
    minY: ${inputMinY.value},
    
    // ä¸‹é‚Šç•Œ (Y Max)
    maxY: ${inputMaxY.value}
};`;

        navigator.clipboard.writeText(code).then(() => {
            alert("âœ… è¨­å®šç¢¼å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ config.js ä¸¦è²¼ä¸Šè¦†è“‹ã€‚");
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—', err);
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½");
        });
    }

    // åŠ ä¸Šåƒè€ƒæ ¼ç·šæ–¹ä¾¿å°é½Š
    L.GridLayer.DebugCoords = L.GridLayer.extend({
        createTile: function (coords) {
            var tile = document.createElement('div');
            tile.style.outline = '1px solid rgba(0,0,0,0.1)';
            return tile;
        }
    });
    map.addLayer(new L.GridLayer.DebugCoords());

</script>

</body>
</html>