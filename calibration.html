<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v5.3 (é»æ“Šä¿®æ­£ç‰ˆ)</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; }
        
        /* å³ä¸Šè§’æ§åˆ¶é¢æ¿ */
        #controls {
            position: fixed; top: 10px; right: 10px; width: 280px;
            background: rgba(0,0,0,0.9); border: 2px solid #00ff00;
            padding: 15px; border-radius: 8px; z-index: 9999;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        
        /* åœ–ç‰‡å®¹å™¨ */
        #map-container {
            margin-top: 20px;
            border: 2px dashed #555;
            overflow: auto; /* å…è¨±æ²å‹• */
            position: relative;
            background: #333;
            cursor: crosshair; /* æ»‘é¼ è®Šåå­— */
        }

        /* åœ–ç‰‡æ¨£å¼ï¼šä¸åš max-width é™åˆ¶ï¼Œè®“å®ƒä»¥åŸå§‹å¤§å°é¡¯ç¤ºï¼Œé¿å…ç¸®æ”¾èª¤å·® */
        #target-img {
            display: block;
            cursor: crosshair;
        }

        button { padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 5px; }
        .btn-green { background: #28a745; color: white; border: none; }
        
        #instruction { margin: 10px 0; font-weight:bold; color: #4db8ff; font-size: 14px; }
        #status-log { color: #ffff00; font-family: monospace; margin-top: 10px; font-size: 12px; white-space: pre-wrap; border-top: 1px solid #555; padding-top: 5px;}

        /* æ¨™è¨˜é» */
        .marker {
            position: absolute; width: 12px; height: 12px; background: rgba(255, 0, 0, 0.8);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 1000;
        }
        .marker.p2 { background: rgba(0, 100, 255, 0.8); }
    </style>
</head>
<body>

<!-- æ§åˆ¶å€ -->
<div id="controls">
    <h3 style="margin:0 0 10px 0;">ğŸ› ï¸ æ ¡æ­£ v5.3</h3>
    
    <input type="file" id="fileInput" accept="image/*" onchange="loadFile(this)">
    
    <div id="instruction">æ­¥é©Ÿ 1: è«‹é¸æ“‡åœ–ç‰‡</div>

    <button id="copyBtn" class="btn-green" style="display:none;" onclick="copyCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
    
    <div id="status-log">ç³»çµ±æº–å‚™å°±ç·’...</div>
</div>

<!-- åœ–ç‰‡é¡¯ç¤ºå€ -->
<div id="map-container">
    <!-- é€™è£¡ä¸åŠ ä»»ä½•è“‹æ¿ï¼Œç›´æ¥æ”¾åœ–ç‰‡ -->
    <img id="target-img" alt="" />
</div>

<script>
    // ============================
    // 1. åŸºæº–é»åº§æ¨™ (è«‹å‹¿ä¿®æ”¹)
    // ============================
    // é» A: ç£å…§ (å³ä¸Š)
    const pointA = { name: "ç£å…§", gameX: 6259, gameY: -9041 };
    // é» B: ä¸­æ¾³ (å·¦ä¸‹)
    const pointB = { name: "ä¸­æ¾³", gameX: -1531, gameY: -1010 };

    // è®Šæ•¸
    let step = 0;
    let imgNaturalWidth = 0;
    let imgNaturalHeight = 0;
    let p1_pixel = null; // é»1 (ç£å…§) çš„åƒç´ åº§æ¨™
    let p2_pixel = null; // é»2 (ä¸­æ¾³) çš„åƒç´ åº§æ¨™
    let currentFileName = "map_bg.png";

    const logEl = document.getElementById('status-log');
    const imgEl = document.getElementById('target-img');
    const instruct = document.getElementById('instruction');

    function log(msg) {
        logEl.innerText = msg + "\n" + logEl.innerText; // æ–°è¨Šæ¯åœ¨ä¸Šé¢
    }

    // 2. æª”æ¡ˆè®€å–
    function loadFile(input) {
        if (input.files && input.files[0]) {
            currentFileName = input.files[0].name;
            log("è®€å–ä¸­...");
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imgEl.src = e.target.result;
                
                imgEl.onload = function() {
                    imgNaturalWidth = this.naturalWidth;
                    imgNaturalHeight = this.naturalHeight;
                    log(`âœ… è¼‰å…¥æˆåŠŸ (${imgNaturalWidth}x${imgNaturalHeight})`);
                    
                    // é‡ç½®ç‹€æ…‹
                    step = 1;
                    p1_pixel = null; p2_pixel = null;
                    document.querySelectorAll('.marker').forEach(e => e.remove());
                    document.getElementById('copyBtn').style.display = 'none';
                    
                    instruct.innerText = "æ­¥é©Ÿ 2: è«‹é»æ“Šåœ–ä¸Šçš„ã€Œç£å…§ã€(å³ä¸Š)";
                    instruct.style.color = "#ff4444"; 
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. é»æ“Šé‚è¼¯ (ç›´æ¥ä½¿ç”¨ offsetX/offsetY æœ€æº–ç¢º)
    imgEl.addEventListener('click', function(e) {
        if (step === 0) return;

        // e.offsetX / e.offsetY æ˜¯ç›¸å°æ–¼åœ–ç‰‡å·¦ä¸Šè§’çš„åƒç´ ä½ç½®
        // å› ç‚ºæˆ‘å€‘æ²’æœ‰è¨­ CSS width/heightï¼Œæ‰€ä»¥é¡¯ç¤ºå¤§å° = åŸå§‹å¤§å°
        // é€™æ¨£å°±ä¸éœ€è¦æ›ç®—ç¸®æ”¾æ¯”ä¾‹ï¼Œç›´æ¥å°±æ˜¯æœ€æº–çš„åƒç´ åº§æ¨™
        const clickX = e.offsetX;
        const clickY = e.offsetY;

        log(`é»æ“Šåº§æ¨™ P${step}: ${clickX}, ${clickY}`);
        
        // åœ¨é»æ“Šè™•ç”¢ç”Ÿæ¨™è¨˜ (è¦–è¦ºå›é¥‹)
        createMarker(e.pageX, e.pageY, step);

        if (step === 1) {
            p1_pixel = { x: clickX, y: clickY };
            step = 2;
            instruct.innerText = "æ­¥é©Ÿ 3: è«‹é»æ“Šåœ–ä¸Šçš„ã€Œä¸­æ¾³ã€(å·¦ä¸‹)";
            instruct.style.color = "#4488ff"; 
        } else if (step === 2) {
            p2_pixel = { x: clickX, y: clickY };
            step = 3;
            instruct.innerText = "âœ… è¨ˆç®—å®Œæˆï¼è«‹è¤‡è£½ä»£ç¢¼";
            instruct.style.color = "#00ff00";
            document.getElementById('copyBtn').style.display = 'block';
            calculate();
        }
    });

    function createMarker(pageX, pageY, stepIdx) {
        const marker = document.createElement('div');
        marker.className = stepIdx === 1 ? 'marker' : 'marker p2';
        marker.style.left = pageX + 'px';
        marker.style.top = pageY + 'px';
        document.body.appendChild(marker);
    }

    // 4. é€†æ¨ç®—æ³•
    function calculate() {
        // è¨ˆç®—æ¯åƒç´ ä»£è¡¨å¤šå°‘éŠæˆ²å–®ä½ (Scale)
        // åœ–ç‰‡ X è»¸ (å‘å³) å°æ‡‰ éŠæˆ² X è»¸ (å‘å³å¢åŠ )
        const scaleX = (pointB.gameX - pointA.gameX) / (p2_pixel.x - p1_pixel.x);
        
        // åœ–ç‰‡ Y è»¸ (å‘ä¸‹) å°æ‡‰ éŠæˆ² Y è»¸ (å‘ä¸‹å¢åŠ ? é‚„æ˜¯å‘ä¸Šå¢åŠ ?)
        // åœ¨ Leaflet çš„ CRS.Simple æˆ–æ˜¯æ‚¨çš„éŠæˆ²é‚è¼¯ä¸­ï¼š
        // ç£å…§ Y = -9041 (ä¸Šæ–¹)
        // ä¸­æ¾³ Y = -1010 (ä¸‹æ–¹)
        // æ‰€ä»¥å¾ä¸Šåˆ°ä¸‹ï¼ŒéŠæˆ² Y å€¼æ˜¯ å¢åŠ çš„ (-9000 -> -1000)
        const scaleY = (pointB.gameY - pointA.gameY) / (p2_pixel.y - p1_pixel.y);

        // æ¨ç®—åœ–ç‰‡å·¦ä¸Šè§’ (0,0) çš„éŠæˆ²åº§æ¨™
        // MinX = é»AéŠæˆ²X - (é»Aåƒç´ X * ScaleX)
        const minX = pointA.gameX - (p1_pixel.x * scaleX);
        const minY = pointA.gameY - (p1_pixel.y * scaleY);

        // æ¨ç®—åœ–ç‰‡å³ä¸‹è§’
        const maxX = minX + (imgNaturalWidth * scaleX);
        const maxY = minY + (imgNaturalHeight * scaleY);

        window.resultCode = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v5.3 é€†å‘æ ¡æ­£)
// ==========================================
const mapSettings = {
    imageName: "${currentFileName}",
    
    // è¨ˆç®—çµæœ
    minX: ${Math.round(minX)},
    maxX: ${Math.round(maxX)},
    minY: ${Math.round(minY)},
    maxY: ${Math.round(maxY)}
};`;
        log("è¨ˆç®—å®Œç•¢ï¼Œè«‹æŒ‰æŒ‰éˆ•è¤‡è£½ã€‚");
    }

    function copyCode() {
        navigator.clipboard.writeText(window.resultCode).then(() => {
            alert("âœ… å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ config.js å…¨é¸ä¸¦è²¼ä¸Šè¦†è“‹ã€‚");
        });
    }
</script>

</body>
</html>
