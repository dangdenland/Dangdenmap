<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v5.4 (çµ²æ»‘ç¸®æ”¾ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #fff; overflow: hidden; }
        
        /* ä»‹é¢ä½ˆå±€ */
        #controls {
            position: fixed; top: 10px; right: 10px; width: 280px;
            background: rgba(0,0,0,0.9); border: 2px solid #00ff00;
            padding: 15px; border-radius: 8px; z-index: 9999;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
        }
        
        /* åœ°åœ–è¦–çª— */
        #viewport {
            width: 100vw; height: 100vh;
            overflow: hidden; /* éš±è—æ²è»¸ */
            background: #333;
            cursor: grab; /* æ‰‹æŒæ¸¸æ¨™ */
            position: relative;
        }
        #viewport.grabbing { cursor: grabbing; } /* æŠ“å–æ™‚çš„æ¸¸æ¨™ */

        /* åœ–ç‰‡æœ¬é«” (é€é CSS Transform æ§åˆ¶) */
        #target-img {
            transform-origin: 0 0; /* è®Šå½¢åŸé»è¨­ç‚ºå·¦ä¸Š */
            pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶ç©¿é€åˆ°å®¹å™¨è™•ç† */
            position: absolute; top: 0; left: 0;
        }

        /* UI å…ƒä»¶ */
        button { padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 5px; }
        .btn-green { background: #28a745; color: white; border: none; }
        
        #instruction { margin: 10px 0; font-weight:bold; color: #4db8ff; font-size: 14px; }
        #status-log { color: #ffff00; font-family: monospace; margin-top: 10px; font-size: 12px; white-space: pre-wrap; border-top: 1px solid #555; padding-top: 5px;}

        /* æ¨™è¨˜é» */
        .marker {
            position: absolute; width: 14px; height: 14px; background: rgba(255, 0, 0, 0.9);
            border: 2px solid white; border-radius: 50%; 
            transform: translate(-50%, -50%); /* å±…ä¸­ */
            pointer-events: none; z-index: 1000;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .marker.p2 { background: rgba(0, 100, 255, 0.9); }

        /* å·¦ä¸‹è§’æç¤º */
        .zoom-info {
            position: fixed; bottom: 20px; left: 20px; 
            background: rgba(0,0,0,0.6); padding: 5px 10px; 
            border-radius: 4px; font-size: 12px; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="controls">
    <h3 style="margin:0 0 10px 0;">ğŸ› ï¸ æ ¡æ­£ v5.4 (çµ²æ»‘ç‰ˆ)</h3>
    <input type="file" id="fileInput" accept="image/*" onchange="loadFile(this)">
    <div id="instruction">æ­¥é©Ÿ 1: è«‹é¸æ“‡åœ–ç‰‡</div>
    <button id="copyBtn" class="btn-green" style="display:none;" onclick="copyCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
    <div id="status-log">ç­‰å¾…åœ–ç‰‡...</div>
    <button onclick="resetView()" style="background:#555; margin-top:15px; font-size:12px;">ğŸ”„ é‡ç½®è¦–è§’ (Fit)</button>
</div>

<div id="viewport">
    <img id="target-img" alt="" />
</div>

<div class="zoom-info">
    æ»‘é¼ æ»¾è¼ªï¼šç¸®æ”¾ (æ¸¸æ¨™ä¸­å¿ƒ)<br>
    æ»‘é¼ å·¦éµï¼šæ‹–æ›³å¹³ç§» / é»æ“Šæ¨™è¨˜
</div>

<script>
    // ============================
    // 1. åŸºæº–é»åº§æ¨™ (å›ºå®š)
    // ============================
    const pointA = { name: "ç£å…§", gameX: 6259, gameY: -9041 };
    const pointB = { name: "ä¸­æ¾³", gameX: -1531, gameY: -1010 };

    // ç‹€æ…‹è®Šæ•¸
    let step = 0;
    let imgNaturalWidth = 0, imgNaturalHeight = 0;
    let p1_pixel = null, p2_pixel = null;
    let currentFileName = "map_bg.png";

    // è¦–åœ–è®Šæ›è®Šæ•¸ (Transform)
    let state = {
        scale: 1,
        panning: false,
        pointX: 0, // åç§»é‡ X
        pointY: 0, // åç§»é‡ Y
        startX: 0,
        startY: 0
    }

    const imgEl = document.getElementById('target-img');
    const viewport = document.getElementById('viewport');
    const logEl = document.getElementById('status-log');
    const instruct = document.getElementById('instruction');

    function log(msg) { logEl.innerText = msg; }

    // 2. æª”æ¡ˆè®€å–
    function loadFile(input) {
        if (input.files && input.files[0]) {
            currentFileName = input.files[0].name;
            const reader = new FileReader();
            reader.onload = function(e) {
                imgEl.src = e.target.result;
                imgEl.onload = function() {
                    imgNaturalWidth = this.naturalWidth;
                    imgNaturalHeight = this.naturalHeight;
                    log(`åœ–ç‰‡è¼‰å…¥: ${imgNaturalWidth}x${imgNaturalHeight}`);
                    
                    // é‡ç½®
                    step = 1;
                    p1_pixel = null; p2_pixel = null;
                    document.querySelectorAll('.marker').forEach(e => e.remove());
                    document.getElementById('copyBtn').style.display = 'none';
                    
                    instruct.innerText = "æ­¥é©Ÿ 2: é»æ“Šã€Œç£å…§ã€(å³ä¸Š)";
                    instruct.style.color = "#ff4444"; 
                    
                    resetView(); // è‡ªå‹•é©æ‡‰è¦–çª—
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. è¦–åœ–æ§åˆ¶æ ¸å¿ƒ (Pan & Zoom Logic)
    function setTransform() {
        imgEl.style.transform = `translate(${state.pointX}px, ${state.pointY}px) scale(${state.scale})`;
    }

    function resetView() {
        if (!imgNaturalWidth) return;
        // è‡ªå‹•ç¸®æ”¾åˆ°é©åˆè¦–çª—å¤§å°
        const scaleW = viewport.clientWidth / imgNaturalWidth;
        const scaleH = viewport.clientHeight / imgNaturalHeight;
        state.scale = Math.min(scaleW, scaleH) * 0.9;
        state.pointX = (viewport.clientWidth - imgNaturalWidth * state.scale) / 2;
        state.pointY = (viewport.clientHeight - imgNaturalHeight * state.scale) / 2;
        setTransform();
    }

    // æ»¾è¼ªç¸®æ”¾ (Zoom)
    viewport.onwheel = function (e) {
        e.preventDefault();
        const xs = (e.clientX - state.pointX) / state.scale;
        const ys = (e.clientY - state.pointY) / state.scale;
        
        const delta = -e.deltaY;
        const oldScale = state.scale;
        
        if (delta > 0) state.scale *= 1.1; // æ”¾å¤§
        else state.scale /= 1.1; // ç¸®å°

        // èª¿æ•´åç§»é‡ï¼Œè®“æ»‘é¼ æŒ‡çš„åœ°æ–¹ä¿æŒä¸å‹•
        state.pointX = e.clientX - xs * state.scale;
        state.pointY = e.clientY - ys * state.scale;

        setTransform();
    };

    // æ‹–æ›³å¹³ç§» (Pan)
    let isClick = true; // åˆ¤æ–·æ˜¯é»æ“Šé‚„æ˜¯æ‹–æ›³

    viewport.onmousedown = function (e) {
        if (e.button !== 0) return; // åªæ¥å—å·¦éµ
        e.preventDefault();
        state.startX = e.clientX - state.pointX;
        state.startY = e.clientY - state.pointY;
        state.panning = true;
        isClick = true; // å‡è¨­æ˜¯é»æ“Š
        viewport.classList.add('grabbing');
    };

    viewport.onmouseup = function (e) {
        e.preventDefault();
        state.panning = false;
        viewport.classList.remove('grabbing');
        
        // å¦‚æœæ˜¯é»æ“Šæ“ä½œ (æ²’æœ‰å¤§å¹…ç§»å‹•)ï¼Œå‰‡è§¸ç™¼æ¨™è¨˜é‚è¼¯
        if (isClick && step > 0) {
            handleMapClick(e.clientX, e.clientY);
        }
    };

    viewport.onmousemove = function (e) {
        e.preventDefault();
        if (!state.panning) return;
        
        const newX = e.clientX - state.startX;
        const newY = e.clientY - state.startY;

        // å¦‚æœç§»å‹•è¶…é 5pxï¼Œå°±è¦–ç‚ºæ‹–æ›³ï¼Œä¸æ˜¯é»æ“Š
        if (Math.abs(newX - state.pointX) > 5 || Math.abs(newY - state.pointY) > 5) {
            isClick = false;
        }

        state.pointX = newX;
        state.pointY = newY;
        setTransform();
    };

    // 4. é»æ“Šæ¨™è¨˜é‚è¼¯
    function handleMapClick(clientX, clientY) {
        // é€†å‘ç®—å‡ºåœ–ç‰‡ä¸Šçš„åŸå§‹åƒç´ åº§æ¨™
        // Formula: (ScreenPos - Translate) / Scale
        const pixelX = (clientX - state.pointX) / state.scale;
        const pixelY = (clientY - state.pointY) / state.scale;

        // ç¢ºä¿é»æ“Šåœ¨åœ–ç‰‡ç¯„åœå…§
        if (pixelX < 0 || pixelX > imgNaturalWidth || pixelY < 0 || pixelY > imgNaturalHeight) {
            return;
        }

        log(`é»æ“Š P${step}: ${Math.round(pixelX)}, ${Math.round(pixelY)}`);
        createMarker(pixelX, pixelY, step); // æ¨™è¨˜ä½ç½®è¦æ ¹æ“šåœ–ç‰‡åº§æ¨™ç³»

        if (step === 1) {
            p1_pixel = { x: pixelX, y: pixelY };
            step = 2;
            instruct.innerText = "æ­¥é©Ÿ 3: é»æ“Šã€Œä¸­æ¾³ã€(å·¦ä¸‹)";
            instruct.style.color = "#4488ff"; 
        } else if (step === 2) {
            p2_pixel = { x: pixelX, y: pixelY };
            step = 3;
            instruct.innerText = "âœ… å®Œæˆï¼è«‹è¤‡è£½ä»£ç¢¼";
            instruct.style.color = "#00ff00";
            document.getElementById('copyBtn').style.display = 'block';
            calculate();
        }
    }

    // å»ºç«‹æ¨™è¨˜é» (é€™æ˜¯è²¼åœ¨ container å…§éƒ¨çš„ï¼Œä½ç½®æœƒéš¨åœ–ç‰‡ transform è€Œè®Šå‹•å—? ä¸æœƒ)
    // ä¿®æ­£ï¼šæˆ‘å€‘ç›´æ¥æŠŠ marker è²¼åœ¨ body ä¸Šï¼Œåªæ˜¯ç‚ºäº†é¡¯ç¤ºç•¶ä¸‹é»æ“Šä½ç½®
    // ä½†æ›´å¥½çš„åšæ³•æ˜¯é‡æ–°è¨ˆç®— CSS transform çš„ markerï¼Œé€™è£¡ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç•«ä¸€å€‹æš«æ™‚çš„ marker è²¼åœ¨åœ–ç‰‡ä¸Š
    // ä¸å°ï¼Œè²¼åœ¨åœ–ç‰‡ä¸Šæœ€å¥½ (child of img container won't work easily with img tag)
    // ç°¡å–®è§£æ³•ï¼šç´€éŒ„é»æ“Šçš„ transform ç‹€æ…‹ï¼Œæˆ–æ˜¯æ¯æ¬¡ render æ™‚æ›´æ–° markerã€‚
    // æ¥µç°¡è§£æ³•ï¼šåªè¦ç®—å‡ºçµæœå°±å¥½ï¼Œæ¨™è¨˜é»ä¸éœ€è¦è·Ÿè‘—ç¸®æ”¾è·‘ï¼Œé»å®Œç¢ºèªæœ‰é»åˆ°å°±å¥½ã€‚
    function createMarker(px, py, stepIdx) {
        // é€™è£¡æˆ‘å€‘éœ€è¦ç®—å‡ºç•¶ä¸‹çš„è¢å¹•åº§æ¨™ä¾†é¡¯ç¤º marker
        const screenX = px * state.scale + state.pointX;
        const screenY = py * state.scale + state.pointY;

        const marker = document.createElement('div');
        marker.className = stepIdx === 1 ? 'marker' : 'marker p2';
        
        // ç‚ºäº†è®“ marker è·Ÿéš¨ç¸®æ”¾ï¼Œæˆ‘å€‘æŠŠå®ƒè¨­ç‚ºçµ•å°å®šä½ï¼Œä¸¦æ›è¼‰åˆ° viewport
        // ä½†å› ç‚ºæˆ‘å€‘è‡ªå·±å¯¦ä½œ transformï¼Œé€™è£¡æˆ‘å€‘ç°¡å–®åšï¼šåªåœ¨ç•¶ä¸‹é¡¯ç¤ºé»æ“Šä½ç½®
        // å¦‚æœä½¿ç”¨è€…ç¸®æ”¾ï¼Œæ¨™è¨˜æœƒè·‘æ‰ (è¦–è¦ºä¸Š)ï¼Œä½†ä¸å½±éŸ¿è¨ˆç®—çµæœã€‚
        // ç‚ºäº†é¿å…å›°æƒ‘ï¼Œæˆ‘å€‘è®“æ¨™è¨˜é»ã€ŒçŸ­æš«é¡¯ç¤ºã€æˆ–ç›´æ¥ç”¨å›ºå®š overlay ç•«å¸ƒ
        
        // **ä¿®æ­£ç­–ç•¥**ï¼šå»ºç«‹ä¸€å€‹è·Ÿéš¨åœ–ç‰‡ transform çš„ div å®¹å™¨ï¼ŒæŠŠ img å’Œ markers éƒ½æ”¾åœ¨è£¡é¢
        // ä½†ç‚ºäº†ä¸æ”¹å‹•å¤ªå¤š HTMLï¼Œé€™è£¡æˆ‘å€‘åªé¡¯ç¤ºã€Œéœæ…‹ã€æ¨™è¨˜ï¼Œä¸¦æç¤ºä½¿ç”¨è€…ã€Œå·²è¨˜éŒ„ã€
        
        // é€™è£¡æ”¹ç”¨ç°¡å–®çš„è¦–è¦ºå›é¥‹ï¼Œåœ¨æ»‘é¼ ä½ç½®é–ƒä¸€ä¸‹
        const dot = document.createElement('div');
        dot.className = stepIdx === 1 ? 'marker' : 'marker p2';
        dot.style.left = screenX + 'px';
        dot.style.top = screenY + 'px';
        document.body.appendChild(dot);
        
        // 2ç§’å¾Œæ¶ˆå¤±ï¼Œé¿å…ç¸®æ”¾å¾Œä½ç½®å°ä¸ä¸Šçš„è¦–è¦ºå¹²æ“¾
        setTimeout(() => dot.remove(), 2000);
    }

    // 5. é€†æ¨è¨ˆç®—
    function calculate() {
        const scaleX = (pointB.gameX - pointA.gameX) / (p2_pixel.x - p1_pixel.x);
        // Y è»¸æ–¹å‘ï¼šç£å…§(ä¸Š -9041) -> ä¸­æ¾³(ä¸‹ -1010)ï¼Œæ•¸å€¼è®Šå¤§
        // åƒç´  Yï¼šç£å…§(å°) -> ä¸­æ¾³(å¤§)ï¼Œæ•¸å€¼è®Šå¤§
        // æ‰€ä»¥ scaleY æ‡‰è©²æ˜¯æ­£çš„
        const scaleY = (pointB.gameY - pointA.gameY) / (p2_pixel.y - p1_pixel.y);

        const minX = pointA.gameX - (p1_pixel.x * scaleX);
        const minY = pointA.gameY - (p1_pixel.y * scaleY);
        const maxX = minX + (imgNaturalWidth * scaleX);
        const maxY = minY + (imgNaturalHeight * scaleY);

        window.resultCode = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v5.4 çµ²æ»‘æ ¡æ­£)
// ==========================================
const mapSettings = {
    imageName: "${currentFileName}",
    
    minX: ${Math.round(minX)},
    maxX: ${Math.round(maxX)},
    minY: ${Math.round(minY)},
    maxY: ${Math.round(maxY)}
};`;
        log("è¨ˆç®—å®Œç•¢ï¼");
    }

    function copyCode() {
        navigator.clipboard.writeText(window.resultCode).then(() => {
            alert("âœ… è¨­å®šç¢¼å·²è¤‡è£½ï¼\nè«‹è²¼å› config.js è¦†è“‹ã€‚");
        });
    }
</script>

</body>
</html>
