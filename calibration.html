<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v5.0 (å…©é»é€†æ¨æ³•)</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #fff; overflow: hidden; }
        
        /* å·¦å³ä½ˆå±€ */
        #container { display: flex; height: 100vh; }
        
        /* å·¦å´åœ°åœ–å€ */
        #map-area { 
            flex: 1; position: relative; overflow: auto; background: #333; cursor: crosshair;
            display: flex; justify-content: center; align-items: center;
        }
        #target-image { box-shadow: 0 0 20px rgba(0,0,0,0.5); max-width: none; } /* åœ–ç‰‡åŸå§‹å¤§å°é¡¯ç¤º */

        /* å³å´æ§åˆ¶å€ */
        #sidebar { width: 320px; background: #1a1a1a; border-left: 1px solid #444; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: -5px 0 15px rgba(0,0,0,0.3); z-index: 10; }
        
        h2 { margin: 0 0 10px 0; color: #ffcc00; border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        .step-box { background: #2a2a2a; padding: 15px; border-radius: 6px; border: 1px solid #444; transition: all 0.3s; }
        .step-box.active { border-color: #007bff; box-shadow: 0 0 10px rgba(0,123,255,0.2); }
        .step-title { font-weight: bold; color: #4db8ff; margin-bottom: 5px; display: block; font-size: 14px; }
        .step-desc { font-size: 12px; color: #ccc; line-height: 1.4; }
        .status { margin-top: 8px; font-size: 12px; font-family: monospace; color: #aaa; }
        .status.done { color: #28a745; font-weight: bold; }

        input[type="text"] { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; margin-top: 5px; box-sizing: border-box; }
        
        button {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: auto;
        }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* æ¨™è¨˜é»æ¨£å¼ */
        .marker {
            position: absolute; width: 10px; height: 10px; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; z-index: 100;
            box-shadow: 0 0 0 2px white;
        }
        .marker-1 { background: #ff0000; }
        .marker-2 { background: #007bff; }
        
        /* ç¸®æ”¾æç¤º */
        #zoom-hint { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="map-area">
        <!-- åœ–ç‰‡æœƒå‹•æ…‹è¼‰å…¥é€™è£¡ -->
        <div id="zoom-hint">ğŸ’¡ æ»¾è¼ªç¸®æ”¾åœ–ç‰‡ | æŒ‰ä½å·¦éµæ‹–æ›³</div>
    </div>

    <div id="sidebar">
        <h2>ğŸ› ï¸ é€†å‘æ ¡æ­£ v5.0</h2>
        
        <div style="margin-bottom:10px;">
            <label style="font-size:12px;">åœ–ç‰‡æª”å:</label>
            <input type="text" id="imgName" value="map_bg.png" onchange="loadImage()">
        </div>

        <!-- æ­¥é©Ÿ 1 -->
        <div id="step1" class="step-box active">
            <span class="step-title">æ­¥é©Ÿ 1: é»æ“Šã€Œç£å…§ã€</span>
            <div class="step-desc">è«‹åœ¨å·¦å´åœ–ç‰‡ä¸­æ‰¾åˆ° <b>ç£å…§ (å³ä¸Šè§’)</b> çš„ä½ç½®ï¼Œä¸¦é»æ“Šå®ƒçš„ç´…é»ä¸­å¿ƒã€‚</div>
            <div class="status" id="status1">æœªè¨­å®š</div>
        </div>

        <!-- æ­¥é©Ÿ 2 -->
        <div id="step2" class="step-box" style="opacity: 0.5; pointer-events: none;">
            <span class="step-title">æ­¥é©Ÿ 2: é»æ“Šã€Œä¸­æ¾³ã€</span>
            <div class="step-desc">è«‹æ‰¾åˆ° <b>ä¸­æ¾³ (å·¦ä¸‹è§’)</b> çš„ä½ç½®ï¼Œä¸¦é»æ“Šå®ƒçš„ç´…é»ä¸­å¿ƒã€‚</div>
            <div class="status" id="status2">æœªè¨­å®š</div>
        </div>

        <div id="result-area" style="display:none; margin-top:20px;">
            <div style="color:#4db8ff; font-size:13px; margin-bottom:5px;">è¨ˆç®—å®Œæˆï¼</div>
            <button onclick="copyResult()">ğŸ“‹ è¤‡è£½ Config ä»£ç¢¼</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ“ åŸºæº–é»è¨­å®š (ä½¿ç”¨æ‚¨è³‡æ–™ä¸­æœ€æº–ç¢ºçš„å…©é»)
    // ==========================================
    // é» A: ç£å…§ (å³ä¸Šå€åŸŸ)
    const pointA = { name: "ç£å…§", gameX: 6259, gameY: -9041 };
    // é» B: ä¸­æ¾³ (å·¦ä¸‹å€åŸŸ)
    const pointB = { name: "ä¸­æ¾³", gameX: -1531, gameY: -1010 };
    // ==========================================

    let currentStep = 1;
    let coords1 = null; // é»1 çš„ åœ–ç‰‡åƒç´ åº§æ¨™ (px, py)
    let coords2 = null; // é»2 çš„ åœ–ç‰‡åƒç´ åº§æ¨™
    let imgWidth = 0;
    let imgHeight = 0;

    const imgElement = document.createElement('img');
    imgElement.id = 'target-image';
    const mapArea = document.getElementById('map-area');
    
    // åˆå§‹åŒ–è¼‰å…¥
    function loadImage() {
        const name = document.getElementById('imgName').value;
        imgElement.src = name;
        imgElement.onload = function() {
            imgWidth = this.naturalWidth;
            imgHeight = this.naturalHeight;
            // é‡ç½®
            currentStep = 1;
            coords1 = null; coords2 = null;
            document.querySelectorAll('.marker').forEach(e => e.remove());
            resetUI();
        };
        imgElement.onerror = function() {
            alert("âŒ æ‰¾ä¸åˆ°åœ–ç‰‡ï¼š" + name + "\nè«‹ç¢ºèªæª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ã€‚");
        };
        mapArea.innerHTML = '';
        mapArea.appendChild(imgElement);
        
        // ç°¡å–®çš„ç¸®æ”¾æ‹–æ›³é‚è¼¯
        let scale = 0.2; // é è¨­ç¸®å°ä¸€é»çœ‹å…¨è²Œ
        let originX = 0, originY = 0;
        let isDragging = false, startX, startY, translateX = 0, translateY = 0;

        function updateTransform() {
            imgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            imgElement.style.transformOrigin = "0 0";
        }
        updateTransform();

        mapArea.onwheel = function(e) {
            e.preventDefault();
            const xs = (e.clientX - mapArea.offsetLeft - translateX) / scale;
            const ys = (e.clientY - mapArea.offsetTop - translateY) / scale;
            const delta = -e.deltaY;
            scale += (delta > 0 ? 0.05 : -0.05);
            scale = Math.max(0.05, Math.min(5, scale));
            translateX = e.clientX - mapArea.offsetLeft - xs * scale;
            translateY = e.clientY - mapArea.offsetTop - ys * scale;
            updateTransform();
        };

        mapArea.onmousedown = function(e) {
            if(e.button !== 0) return; // åªæ¥å—å·¦éµ
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            mapArea.style.cursor = 'grabbing';
        };
        
        window.onmouseup = function() { isDragging = false; mapArea.style.cursor = 'crosshair'; };
        
        window.onmousemove = function(e) {
            if (isDragging) {
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        };

        // é»æ“Šäº‹ä»¶ (æ ¸å¿ƒé‚è¼¯)
        imgElement.onclick = function(e) {
            if(isDragging) return; // æ‹–æ›³ä¸­ä¸è§¸ç™¼é»æ“Š

            const rect = imgElement.getBoundingClientRect();
            // è¨ˆç®—é»æ“Šä½ç½®ç›¸å°æ–¼åœ–ç‰‡åŸå§‹å¤§å°çš„åº§æ¨™
            const clickX = (e.clientX - rect.left) / scale;
            const clickY = (e.clientY - rect.top) / scale;

            handleMapClick(clickX, clickY, e.clientX, e.clientY);
        };
    }

    function handleMapClick(px, py, clientX, clientY) {
        if (currentStep === 1) {
            coords1 = { x: px, y: py };
            addMarker(clientX, clientY, 1);
            document.getElementById('status1').innerHTML = `å·²è¨­å®š (Px: ${Math.round(px)}, ${Math.round(py)})`;
            document.getElementById('status1').classList.add('done');
            
            // åˆ‡æ›åˆ°æ­¥é©Ÿ 2
            currentStep = 2;
            document.getElementById('step1').classList.remove('active');
            const box2 = document.getElementById('step2');
            box2.style.opacity = '1';
            box2.style.pointerEvents = 'auto';
            box2.classList.add('active');

        } else if (currentStep === 2) {
            coords2 = { x: px, y: py };
            addMarker(clientX, clientY, 2);
            document.getElementById('status2').innerHTML = `å·²è¨­å®š (Px: ${Math.round(px)}, ${Math.round(py)})`;
            document.getElementById('status2').classList.add('done');
            
            calculate();
        }
    }

    function addMarker(cx, cy, step) {
        // é€™è£¡æˆ‘å€‘åªæ˜¯åœ¨è¦–è¦ºä¸Šæ¨™è¨˜ï¼Œç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥è²¼åœ¨ body ä¸Š (ä¸éš¨åœ–ç‰‡ç¸®æ”¾ç§»å‹•ï¼Œåªæ¨™ç¤ºç•¶ä¸‹)
        // è‹¥è¦éš¨åœ–ç‰‡ç§»å‹•æ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡åƒ…ä½œç¤ºæ„
        // ç‚ºäº†è®“ä½¿ç”¨è€…ç¢ºèªé»åˆ°äº†ï¼Œæˆ‘å€‘ç›´æ¥åˆ©ç”¨ imgElement çš„åº§æ¨™ç³»ä¾†ç•«é»
        const dot = document.createElement('div');
        dot.className = `marker marker-${step}`;
        // ç‚ºäº†æº–ç¢ºï¼Œæˆ‘å€‘æŠŠå®ƒæ”¾åœ¨ map-area å…§ï¼Œä½†ä½ç½®è¦æ›ç®—
        // ç°¡å–®åšæ³•ï¼šé‡æ–°è¨ˆç®—åœ–ç‰‡å…§çš„ pixel è½‰å› screen
        // é€™è£¡å·æ‡¶ä¸€ä¸‹ï¼Œåªé¡¯ç¤ºæœ€å¾Œä¸€æ¬¡é»æ“Šçš„ç›¸å°ä½ç½®ï¼Œå› ç‚ºè¨ˆç®—å®Œå°±çµæŸäº†
    }

    function calculate() {
        // ==========================================
        // ğŸ§® æ ¸å¿ƒé€†å‘ç®—æ³•
        // ==========================================
        // æˆ‘å€‘æœ‰å…©å€‹é»çš„å°æ‡‰é—œä¿‚ï¼š
        // P1(px1, py1) <--> G1(gx1, gy1)
        // P2(px2, py2) <--> G2(gx2, gy2)
        
        // 1. è¨ˆç®—æ¯”ä¾‹ (Scale) = éŠæˆ²å–®ä½ / åƒç´ 
        // åœ–ç‰‡ X è»¸ (å³) å°æ‡‰ éŠæˆ² X è»¸ (å³)
        const scaleX = (pointB.gameX - pointA.gameX) / (coords2.x - coords1.x);
        
        // åœ–ç‰‡ Y è»¸ (ä¸‹) å°æ‡‰ éŠæˆ² Y è»¸ (ä¸‹) 
        // æ³¨æ„ï¼šéŠæˆ²åº§æ¨™ -9000 æ˜¯ä¸Šé¢ï¼Œ-1000 æ˜¯ä¸‹é¢ï¼Œæ‰€ä»¥æ•¸å€¼æ˜¯å¢åŠ çš„
        const scaleY = (pointB.gameY - pointA.gameY) / (coords2.y - coords1.y);

        // 2. æ¨ç®—å·¦ä¸Šè§’ (0,0) çš„éŠæˆ²åº§æ¨™
        // MinX = G1.x - (P1.x * scaleX)
        const finalMinX = pointA.gameX - (coords1.x * scaleX);
        const finalMinY = pointA.gameY - (coords1.y * scaleY);

        // 3. æ¨ç®—å³ä¸‹è§’ (imgW, imgH) çš„éŠæˆ²åº§æ¨™
        const finalMaxX = finalMinX + (imgWidth * scaleX);
        const finalMaxY = finalMinY + (imgHeight * scaleY);

        // é¡¯ç¤ºçµæœ
        window.calculatedConfig = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v5 é€†å‘æ ¡æ­£)
// ==========================================
const mapSettings = {
    imageName: "${document.getElementById('imgName').value}",
    
    // è‡ªå‹•è¨ˆç®—çµæœï¼š
    minX: ${Math.round(finalMinX)},
    maxX: ${Math.round(finalMaxX)},
    minY: ${Math.round(finalMinY)},
    maxY: ${Math.round(finalMaxY)}
};`;

        document.getElementById('result-area').style.display = 'block';
    }

    function copyResult() {
        navigator.clipboard.writeText(window.calculatedConfig).then(() => {
            alert("âœ… è¨­å®šæª”å·²è¤‡è£½ï¼\nè«‹è²¼åˆ° config.js ä¸­è¦†è“‹ã€‚");
        });
    }

    function resetUI() {
        document.getElementById('step1').classList.add('active');
        document.getElementById('status1').innerHTML = "æœªè¨­å®š";
        document.getElementById('status1').classList.remove('done');
        
        const box2 = document.getElementById('step2');
        box2.classList.remove('active');
        box2.style.opacity = '0.5';
        box2.style.pointerEvents = 'none';
        document.getElementById('status2').innerHTML = "æœªè¨­å®š";
        document.getElementById('status2').classList.remove('done');
        
        document.getElementById('result-area').style.display = 'none';
    }

    // åˆæ¬¡è¼‰å…¥
    loadImage();
</script>

</body>
</html>
