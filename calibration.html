<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v4.1 (é™¤éŒ¯ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; }
        #map { height: 100vh; width: 100vw; background-color: #333; }

        /* é¢æ¿æ¨£å¼ */
        #panel {
            position: fixed; top: 10px; right: 10px; z-index: 9999;
            background: rgba(0, 0, 0, 0.9); color: #fff; padding: 15px;
            border-radius: 8px; width: 340px; font-size: 14px;
            border: 1px solid #666; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 12px;
            max-height: 90vh; overflow-y: auto;
        }
        h2 { margin: 0; font-size: 18px; color: #ffcc00; border-bottom: 1px solid #555; padding-bottom: 8px; text-align: center; }
        
        .control-group { background: #2a2a2a; padding: 10px; border-radius: 4px; border: 1px solid #444; }
        .group-title { font-weight: bold; color: #4db8ff; margin-bottom: 8px; display: block; font-size: 13px; }
        
        .radio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; }
        .radio-label { 
            display: flex; align-items: center; justify-content: center;
            background: #444; padding: 6px; border-radius: 4px; cursor: pointer; border: 1px solid #555; font-size: 12px;
        }
        .radio-label:hover { background: #555; }
        .radio-label input { margin-right: 5px; }
        .radio-label.active { background: #007bff; border-color: #0056b3; color: white; }

        .desc { font-size: 12px; color: #ccc; line-height: 1.4; margin-top: 5px; }
        .key-hint { display: inline-block; padding: 1px 5px; background: #555; border-radius: 3px; font-family: monospace; color: #fff; border: 1px solid #777; font-size: 11px; }

        .btn-copy {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 5px;
        }
        .btn-copy:hover { background-color: #218838; }
        
        /* è®“åœ“é»æ›´æ˜é¡¯ */
        .leaflet-marker-icon { opacity: 0.9 !important; border: 1px solid white; border-radius: 50%; }
        .debug-info { font-family: monospace; font-size: 10px; color: #666; text-align: center; margin-top: 5px;}

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"], input[type="number"] {
            width: 100%; box-sizing: border-box; padding: 5px;
            background: #444; color: #fff; border: 1px solid #666; margin-top: 5px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h2>ğŸ› ï¸ åœ°åœ–æ ¡æ­£ v4.1 (é™¤éŒ¯ç‰ˆ)</h2>

    <!-- é™¤éŒ¯å€ï¼šåœ–ç‰‡è¨­å®š -->
    <div class="control-group" style="border-color: #ff9800;">
        <span class="group-title" style="color: #ff9800;">âš ï¸ åœ–ç‰‡å‡ºä¸ä¾†ï¼Ÿæª¢æŸ¥é€™è£¡</span>
        <div class="desc">åœ–ç‰‡æª”å (è«‹ç¢ºèªå‰¯æª”å .png/.jpg)</div>
        <input type="text" id="imgNameInput" value="map_bg.png" onchange="updateImageSrc()">
        <div class="desc" id="img-status" style="color: #aaa;">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <!-- æ­¥é©Ÿ 1: é¸æ“‡éŒ¨é» -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 1: é–å®šåƒè€ƒé»</span>
        <div class="radio-group">
            <label class="radio-label" onclick="setAnchor('tl')">
                <input type="radio" name="anchor" value="tl"> â†–ï¸ å·¦ä¸Š
            </label>
            <label class="radio-label active" onclick="setAnchor('tr')">
                <input type="radio" name="anchor" value="tr" checked> â†—ï¸ å³ä¸Š
            </label>
            <label class="radio-label" onclick="setAnchor('bl')">
                <input type="radio" name="anchor" value="bl"> â†™ï¸ å·¦ä¸‹
            </label>
            <label class="radio-label" onclick="setAnchor('br')">
                <input type="radio" name="anchor" value="br"> â†˜ï¸ å³ä¸‹
            </label>
        </div>
        <div class="desc" id="anchor-desc">ç›®å‰é–å®šï¼š<b>â†—ï¸ å³ä¸Šè§’</b><br>æ‹‰ä¼¸æ™‚ï¼Œå³ä¸Šè§’ä¸æœƒå‹•ï¼Œåªå‹•å·¦ä¸‹ã€‚</div>
    </div>

    <!-- æ­¥é©Ÿ 2: å¹³ç§» -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 2: å¹³ç§» (WASD)</span>
        <div class="desc">ç”¨ <span class="key-hint">W</span><span class="key-hint">A</span><span class="key-hint">S</span><span class="key-hint">D</span> ç§»å‹•æ•´å¼µåœ–ã€‚<br>å°‡é–å®šé»çš„æ‘èŠå°é½Šã€‚</div>
    </div>

    <!-- æ­¥é©Ÿ 3: æ‹‰ä¼¸ -->
    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 3: æ‹‰ä¼¸ (æ–¹å‘éµ)</span>
        <div class="desc">ç”¨ <span class="key-hint">â¬†ï¸</span><span class="key-hint">â¬‡ï¸</span><span class="key-hint">â¬…ï¸</span><span class="key-hint">â¡ï¸</span> æ‹‰ä¼¸ã€‚<br>å°‡å°è§’ç·šçš„æ‘èŠå°é½Šã€‚</div>
    </div>

    <div class="control-group" style="padding: 5px 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:12px;">å¾®èª¿é€Ÿåº¦</span>
            <span style="font-size:12px; font-family:monospace;" id="speedVal">20 px</span>
        </div>
        <input type="range" id="speedRange" min="1" max="200" value="20" style="width:100%">
    </div>

    <button class="btn-copy" onclick="copyConfig()">âœ… å®Œæˆï¼è¤‡è£½ä»£ç¢¼</button>
    <div class="debug-info" id="debug-coords"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- å˜—è©¦è®€å–è¨­å®šæª”ï¼Œè®€ä¸åˆ°ä¹Ÿä¸æœƒå´©æ½° -->
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    // é è¨­å€¼ (å¦‚æœ config.js æ²’è®€åˆ°)
    let defaultSettings = { imageName: "map_bg.png", minX: -2560, maxX: 9359, minY: -9728, maxY: 1023 };
    
    // æª¢æ¸¬ config.js æ˜¯å¦æˆåŠŸè¼‰å…¥
    if (typeof mapSettings !== 'undefined') {
        defaultSettings = mapSettings;
    } else {
        console.warn("config.js æœªè¼‰å…¥ï¼Œä½¿ç”¨é è¨­å€¼");
    }

    // åˆå§‹åŒ–è¼¸å…¥æ¡†çš„å€¼
    document.getElementById('imgNameInput').value = defaultSettings.imageName;

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 2, zoomSnap: 0.1, attributionControl: false, zoomControl: false
    });
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // ç¹ªè£½æ‘èŠåƒè€ƒé»
    const bounds = [];
    if (typeof rawData !== 'undefined') {
        rawData.forEach(v => {
            const latLng = [-v.y, v.x];
            bounds.push(latLng);
            L.circleMarker(latLng, {
                radius: 4, color: '#fff', weight:1, fillColor: '#ff0000', fillOpacity: 0.8
            }).bindTooltip(v.name, {permanent: true, direction: 'auto', opacity:0.7}).addTo(map);
        });
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [100, 100] });
    }

    // ç•¶å‰æ•¸å€¼
    let current = {
        minX: defaultSettings.minX, maxX: defaultSettings.maxX,
        minY: defaultSettings.minY, maxY: defaultSettings.maxY
    };

    // å»ºç«‹åº•åœ– (åˆå§‹ç‚ºç©ºï¼Œç¨å¾Œè¼‰å…¥)
    let mapImageLayer = L.imageOverlay(
        defaultSettings.imageName, 
        [[-current.minY, current.minX], [-current.maxY, current.maxX]], 
        { opacity: 0.6, zIndex: -1 }
    );
    mapImageLayer.addTo(map);

    // åœ–ç‰‡è¼‰å…¥ç‹€æ…‹ç›£æ¸¬
    function checkImageStatus() {
        const img = mapImageLayer.getElement();
        const statusDiv = document.getElementById('img-status');
        if (img) {
            img.onload = () => { statusDiv.innerText = "âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸ"; statusDiv.style.color = "#4db8ff"; };
            img.onerror = () => { statusDiv.innerText = "âŒ è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥æª”å/è·¯å¾‘)"; statusDiv.style.color = "#ff6b6b"; };
        }
    }
    // å»¶é²æª¢æ¸¬
    setTimeout(checkImageStatus, 1000);

    // æ›´æ–°åœ–ç‰‡ç¶²å€ (ç•¶ä½¿ç”¨è€…åœ¨è¼¸å…¥æ¡†ä¿®æ”¹æ™‚)
    window.updateImageSrc = function() {
        const newName = document.getElementById('imgNameInput').value;
        mapImageLayer.setUrl(newName);
        setTimeout(checkImageStatus, 500);
    }

    // æ¸²æŸ“å‡½æ•¸
    function render() {
        mapImageLayer.setBounds([[-current.minY, current.minX], [-current.maxY, current.maxX]]);
        document.getElementById('debug-coords').innerText = `X: ${Math.round(current.minX)} ~ ${Math.round(current.maxX)} | Y: ${Math.round(current.minY)} ~ ${Math.round(current.maxY)}`;
    }

    // éŒ¨é»é‚è¼¯
    let currentAnchor = 'tr'; 
    window.setAnchor = function(val) {
        currentAnchor = val;
        document.querySelectorAll('.radio-label').forEach(el => el.classList.remove('active'));
        document.querySelector(`input[value="${val}"]`).parentElement.classList.add('active');
        
        const descMap = {
            'tl': 'ç›®å‰é–å®šï¼š<b>â†–ï¸ å·¦ä¸Šè§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå³å´ã€èˆ‡ã€Œä¸‹æ–¹ã€ã€‚',
            'tr': 'ç›®å‰é–å®šï¼š<b>â†—ï¸ å³ä¸Šè§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå·¦å´ã€èˆ‡ã€Œä¸‹æ–¹ã€ã€‚',
            'bl': 'ç›®å‰é–å®šï¼š<b>â†™ï¸ å·¦ä¸‹è§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå³å´ã€èˆ‡ã€Œä¸Šæ–¹ã€ã€‚',
            'br': 'ç›®å‰é–å®šï¼š<b>â†˜ï¸ å³ä¸‹è§’</b><br>æ–¹å‘éµå°‡æ‹‰ä¼¸ã€Œå·¦å´ã€èˆ‡ã€Œä¸Šæ–¹ã€ã€‚'
        };
        document.getElementById('anchor-desc').innerHTML = descMap[val];
    }
    setAnchor('tr');

    // éµç›¤æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        let step = parseInt(document.getElementById('speedRange').value);
        if (e.shiftKey) step *= 5; 

        // WASD å¹³ç§»
        if (['KeyW','KeyS','KeyA','KeyD'].includes(e.code)) {
            if (e.code === 'KeyW') { current.minY -= step; current.maxY -= step; }
            if (e.code === 'KeyS') { current.minY += step; current.maxY += step; }
            if (e.code === 'KeyA') { current.minX -= step; current.maxX -= step; }
            if (e.code === 'KeyD') { current.minX += step; current.maxX += step; }
            render();
            return;
        }

        // æ–¹å‘éµ æ‹‰ä¼¸
        if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) {
            e.preventDefault();
            if (e.code === 'ArrowUp' || e.code === 'ArrowDown') {
                const isExpand = (e.code === 'ArrowDown');
                const delta = isExpand ? step : -step;
                if (currentAnchor === 'tl' || currentAnchor === 'tr') current.maxY += delta;
                else current.minY -= delta;
            }
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
                const isExpand = (e.code === 'ArrowRight');
                const delta = isExpand ? step : -step;
                if (currentAnchor === 'tl' || currentAnchor === 'bl') current.maxX += delta;
                else current.minX -= delta;
            }
            render();
        }
    });

    document.getElementById('speedRange').addEventListener('input', (e) => {
        document.getElementById('speedVal').innerText = e.target.value + " px";
    });

    window.copyConfig = function() {
        const imgName = document.getElementById('imgNameInput').value;
        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v4.1 æ ¡æ­£å®Œæˆ)
// ==========================================
const mapSettings = {
    imageName: "${imgName}",
    minX: ${Math.round(current.minX)},
    maxX: ${Math.round(current.maxX)},
    minY: ${Math.round(current.minY)},
    maxY: ${Math.round(current.maxY)}
};`;
        navigator.clipboard.writeText(code).then(() => alert("âœ… ä»£ç¢¼å·²è¤‡è£½ï¼")).catch(() => console.log(code));
    }
</script>

</body>
</html>
