<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v5.1 (æª”æ¡ˆé¸å–ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #fff; overflow: hidden; }
        
        #container { display: flex; height: 100vh; }
        
        /* å·¦å´åœ°åœ–å€ */
        #map-area { 
            flex: 1; position: relative; overflow: hidden; background: #333; cursor: crosshair;
            display: flex; justify-content: center; align-items: center;
        }
        #target-image { box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: 0 0; } 

        /* å³å´æ§åˆ¶å€ */
        #sidebar { width: 340px; background: #1a1a1a; border-left: 1px solid #444; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: -5px 0 15px rgba(0,0,0,0.3); z-index: 10; overflow-y: auto; }
        
        h2 { margin: 0 0 10px 0; color: #ffcc00; border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        .control-group { background: #2a2a2a; padding: 15px; border-radius: 6px; border: 1px solid #444; }
        .group-title { font-weight: bold; color: #4db8ff; margin-bottom: 8px; display: block; font-size: 14px; }
        
        /* æª”æ¡ˆé¸å–æŒ‰éˆ• */
        .file-upload {
            position: relative; overflow: hidden; margin: 10px 0;
            background: #444; color: white; border: 1px dashed #888;
            padding: 15px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .file-upload:hover { background: #555; border-color: #aaa; }
        .file-upload input[type=file] {
            position: absolute; top: 0; right: 0; min-width: 100%; min-height: 100%;
            font-size: 100px; text-align: right; filter: alpha(opacity=0); opacity: 0; outline: none; background: white; cursor: inherit; display: block;
        }

        .step-box { background: #2a2a2a; padding: 12px; border-radius: 6px; border: 1px solid #444; opacity: 0.5; pointer-events: none; transition: 0.3s; margin-bottom: 10px; }
        .step-box.active { border-color: #28a745; box-shadow: 0 0 8px rgba(40,167,69,0.3); opacity: 1; pointer-events: auto; }
        .step-desc { font-size: 12px; color: #ccc; line-height: 1.4; margin-top: 5px; }
        .status { margin-top: 5px; font-size: 12px; font-family: monospace; color: #ff6b6b; }
        .status.done { color: #28a745; font-weight: bold; }

        button {
            width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }

        /* æ¨™è¨˜é» */
        .marker {
            position: absolute; width: 12px; height: 12px; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; z-index: 100;
            border: 2px solid white;
        }
        .marker-1 { background: #ff0000; }
        .marker-2 { background: #007bff; }
        
        #zoom-hint { position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="map-area">
        <div id="zoom-hint">ğŸ’¡ æ»¾è¼ªç¸®æ”¾åœ–ç‰‡ | æŒ‰ä½å·¦éµæ‹–æ›³å¹³ç§»</div>
    </div>

    <div id="sidebar">
        <h2>ğŸ› ï¸ é€†å‘æ ¡æ­£ v5.1</h2>
        
        <!-- æª”æ¡ˆè¼‰å…¥å€ -->
        <div class="control-group">
            <span class="group-title">1. è¼‰å…¥åœ°åœ–åœ–ç‰‡</span>
            <div class="file-upload">
                <span id="file-label">ğŸ“‚ é»æ­¤é¸æ“‡é›»è…¦ä¸­çš„åœ–ç‰‡</span>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(this)">
            </div>
            <div style="font-size:11px; color:#888;">æª”å: <span id="fileNameDisplay" style="color:#fff;">æœªé¸æ“‡</span></div>
        </div>

        <!-- æ­¥é©Ÿ 1 -->
        <div id="step1" class="step-box">
            <span class="group-title">2. é»æ“Šã€Œç£å…§ã€ (å³ä¸Š)</span>
            <div class="step-desc">åœ¨åœ°åœ–ä¸Šæ‰¾åˆ° <b>ç£å…§</b>ï¼Œé»æ“Šç´…é»ä¸­å¿ƒã€‚</div>
            <div class="status" id="status1">ç­‰å¾…é»æ“Š...</div>
        </div>

        <!-- æ­¥é©Ÿ 2 -->
        <div id="step2" class="step-box">
            <span class="group-title">3. é»æ“Šã€Œä¸­æ¾³ã€ (å·¦ä¸‹)</span>
            <div class="step-desc">åœ¨åœ°åœ–ä¸Šæ‰¾åˆ° <b>ä¸­æ¾³</b>ï¼Œé»æ“Šç´…é»ä¸­å¿ƒã€‚</div>
            <div class="status" id="status2">ç­‰å¾…é»æ“Š...</div>
        </div>

        <div id="result-area" style="display:none;">
            <button onclick="copyResult()">ğŸ“‹ è¤‡è£½è¨­å®šç¢¼</button>
            <div style="font-size:11px; color:#aaa; margin-top:5px; text-align:center;">è²¼å› config.js å³å¯</div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ“ åŸºæº–é» (ç¢ºä¿åº§æ¨™æ­£ç¢º)
    // ==========================================
    const pointA = { name: "ç£å…§", gameX: 6259, gameY: -9041 };
    const pointB = { name: "ä¸­æ¾³", gameX: -1531, gameY: -1010 };
    // ==========================================

    let imgWidth = 0, imgHeight = 0;
    let currentStep = 0;
    let coords1 = null, coords2 = null;
    let currentFileName = "map_bg.png"; // é è¨­æª”å

    const mapArea = document.getElementById('map-area');
    let imgElement = null;

    // ç¸®æ”¾è®Šæ•¸
    let scale = 0.2;
    let translateX = 0, translateY = 0;
    let isDragging = false, startX, startY;

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            currentFileName = file.name;
            document.getElementById('fileNameDisplay').innerText = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                // æ¸…é™¤èˆŠåœ–
                mapArea.innerHTML = '<div id="zoom-hint">ğŸ’¡ æ»¾è¼ªç¸®æ”¾åœ–ç‰‡ | æŒ‰ä½å·¦éµæ‹–æ›³å¹³ç§»</div>';
                
                imgElement = document.createElement('img');
                imgElement.id = 'target-image';
                imgElement.src = e.target.result;
                imgElement.onload = function() {
                    imgWidth = this.naturalWidth;
                    imgHeight = this.naturalHeight;
                    initMapInteraction();
                    startCalibration();
                };
                mapArea.appendChild(imgElement);
            };
            reader.readAsDataURL(file);
        }
    }

    function initMapInteraction() {
        // é‡ç½®ä½ç½®
        scale = Math.min(mapArea.clientWidth / imgWidth, mapArea.clientHeight / imgHeight) * 0.9;
        translateX = (mapArea.clientWidth - imgWidth * scale) / 2;
        translateY = (mapArea.clientHeight - imgHeight * scale) / 2;
        updateTransform();

        // æ»¾è¼ªç¸®æ”¾
        mapArea.onwheel = function(e) {
            e.preventDefault();
            const rect = imgElement.getBoundingClientRect();
            // æ»‘é¼ åœ¨åœ–ç‰‡ä¸Šçš„ç›¸å°ä½ç½® (0~1)
            const offsetX = (e.clientX - rect.left) / (imgWidth * scale);
            const offsetY = (e.clientY - rect.top) / (imgHeight * scale);

            const delta = -e.deltaY;
            const prevScale = scale;
            scale += (delta > 0 ? scale * 0.1 : -scale * 0.1);
            scale = Math.max(0.01, Math.min(10, scale));

            // èª¿æ•´å¹³ç§»è®“ç¸®æ”¾ä¸­å¿ƒå°æº–æ»‘é¼ 
            translateX -= (scale - prevScale) * imgWidth * offsetX;
            translateY -= (scale - prevScale) * imgHeight * offsetY;
            
            updateTransform();
        };

        // æ‹–æ›³å¹³ç§»
        mapArea.onmousedown = function(e) {
            if(e.button !== 0) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            mapArea.style.cursor = 'grabbing';
        };
        window.onmouseup = function() { isDragging = false; mapArea.style.cursor = 'crosshair'; };
        window.onmousemove = function(e) {
            if (isDragging) {
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        };

        // é»æ“Šåµæ¸¬
        imgElement.onclick = function(e) {
            if(isDragging) return; 
            const rect = imgElement.getBoundingClientRect();
            const px = (e.clientX - rect.left) / scale;
            const py = (e.clientY - rect.top) / scale;
            
            // ç¢ºä¿é»åœ¨åœ–ç‰‡å…§
            if(px >= 0 && px <= imgWidth && py >= 0 && py <= imgHeight) {
                handlePointClick(px, py, e.clientX, e.clientY);
            }
        };
    }

    function updateTransform() {
        if(imgElement) {
            imgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }
    }

    function startCalibration() {
        currentStep = 1;
        coords1 = null; coords2 = null;
        document.querySelectorAll('.marker').forEach(e => e.remove());
        document.getElementById('step1').classList.add('active');
        document.getElementById('status1').innerHTML = "è«‹é»æ“Šåœ–ç‰‡...";
        document.getElementById('status1').className = "status";
        
        document.getElementById('step2').classList.remove('active');
        document.getElementById('status2').innerHTML = "ç­‰å¾…æ­¥é©Ÿ 1...";
        document.getElementById('status2').className = "status";
        
        document.getElementById('result-area').style.display = 'none';
    }

    function handlePointClick(px, py, cx, cy) {
        if (currentStep === 1) {
            coords1 = { x: px, y: py };
            addMarker(cx, cy, 1);
            document.getElementById('status1').innerHTML = `âœ… å·²è¨­å®š (Px: ${Math.round(px)}, ${Math.round(py)})`;
            document.getElementById('status1').classList.add('done');
            document.getElementById('step1').classList.remove('active');
            
            currentStep = 2;
            document.getElementById('step2').classList.add('active');
            document.getElementById('status2').innerHTML = "è«‹é»æ“Šåœ–ç‰‡...";
        } else if (currentStep === 2) {
            coords2 = { x: px, y: py };
            addMarker(cx, cy, 2);
            document.getElementById('status2').innerHTML = `âœ… å·²è¨­å®š (Px: ${Math.round(px)}, ${Math.round(py)})`;
            document.getElementById('status2').classList.add('done');
            
            currentStep = 3;
            document.getElementById('result-area').style.display = 'block';
        }
    }

    function addMarker(cx, cy, step) {
        // ç°¡å–®åœ°åœ¨é»æ“Šè™•è²¼ä¸Šæ¨™è¨˜ (é€™åªæ˜¯è¦–è¦ºå›é¥‹ï¼Œä¸æœƒéš¨ç¸®æ”¾ç§»å‹•ï¼Œä½†è¶³å¤ ç¢ºèªæœ‰é»åˆ°)
        const dot = document.createElement('div');
        dot.className = `marker marker-${step}`;
        dot.style.left = cx + 'px';
        dot.style.top = cy + 'px';
        document.body.appendChild(dot);
    }

    function copyResult() {
        // æ ¸å¿ƒç®—æ³•
        const scaleX = (pointB.gameX - pointA.gameX) / (coords2.x - coords1.x);
        const scaleY = (pointB.gameY - pointA.gameY) / (coords2.y - coords1.y);

        const finalMinX = pointA.gameX - (coords1.x * scaleX);
        const finalMinY = pointA.gameY - (coords1.y * scaleY);
        const finalMaxX = finalMinX + (imgWidth * scaleX);
        const finalMaxY = finalMinY + (imgHeight * scaleY);

        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (v5.1 é€†å‘æ ¡æ­£)
// ==========================================
const mapSettings = {
    imageName: "${currentFileName}", // è«‹ç¢ºä¿åœ–ç‰‡å·²ä¸Šå‚³ä¸”æª”åä¸€è‡´
    
    minX: ${Math.round(finalMinX)},
    maxX: ${Math.round(finalMaxX)},
    minY: ${Math.round(finalMinY)},
    maxY: ${Math.round(finalMaxY)}
};`;

        navigator.clipboard.writeText(code).then(() => {
            alert("âœ… ä»£ç¢¼å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ config.js ä¸¦è²¼ä¸Šè¦†è“‹ã€‚");
        });
    }
</script>

</body>
</html>
