<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ°åœ–ç²¾æº–æ ¡æº–å·¥å…· v6.1 (æŒ‡å®šé»ä½ç‰ˆ)</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #controls { 
            position: fixed; top: 10px; left: 10px; width: 340px; 
            background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; 
            border: 1px solid #444; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.8);
        }
        #viewport { width: 100vw; height: 100vh; cursor: crosshair; position: relative; overflow: hidden; }
        #canvas-container { position: absolute; transform-origin: 0 0; }
        img { display: block; user-select: none; pointer-events: none; }
        
        .marker { position: absolute; width: 14px; height: 14px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10; }
        .m1 { background: #ff4444; box-shadow: 0 0 15px #ff4444; }
        .m2 { background: #4488ff; box-shadow: 0 0 15px #4488ff; }
        
        input { background: #333; color: #0f0; border: 1px solid #555; padding: 5px; width: 90px; font-family: monospace; text-align: center; }
        button { background: #28a745; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; margin-top: 10px; border-radius: 5px; font-weight: bold; font-size: 14px; }
        button:hover { background: #218838; }
        
        pre { background: #000; padding: 12px; font-size: 12px; color: #0f0; border: 1px dashed #555; white-space: pre-wrap; margin-top: 10px; }
        .info { font-size: 12px; color: #aaa; margin: 10px 0; line-height: 1.5; }
        b { color: #fff; }
    </style>
</head>
<body>

<div id="controls">
    <h3 style="margin:0 0 10px 0; color: #00ff00;">ğŸ—ºï¸ åœ°åœ–æ ¡æº– v6.1</h3>
    <input type="file" id="fileInput" accept="image/*" style="width:100%; margin-bottom:10px;">
    
    <p class="info"><b>åŸºæº–é»åº§æ¨™è¨­å®šï¼š</b></p>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; font-size:12px; align-items: center;">
        <span>P1(ç´…):</span>
        <input type="number" id="p1x" value="9200">
        <input type="number" id="p1y" value="-9560">
        
        <span>P2(è—):</span>
        <input type="number" id="p2x" value="-1700">
        <input type="number" id="p2y" value="-230">
    </div>

    <div id="msg" style="color:yellow; margin:15px 0; font-weight:bold; border-left: 4px solid yellow; padding-left: 10px;">è«‹è¼‰å…¥åœ°åœ–åœ–ç‰‡</div>
    
    <div id="result" style="display:none">
        <p class="info">è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼è‡³ <b>config.js</b>ï¼š</p>
        <pre id="output"></pre>
        <button onclick="copyCode()">ğŸ“‹ è¤‡è£½è¨­å®šä»£ç¢¼</button>
    </div>
    
    <button onclick="location.reload()" style="background:#555; font-size:12px;">ğŸ”„ é‡ç½®æ‰€æœ‰æ¨™è¨˜</button>
</div>

<div id="viewport">
    <div id="canvas-container">
        <img id="mapImg">
        <div id="markers"></div>
    </div>
</div>

<script>
    const state = { scale: 1, x: 0, y: 0, step: 1, imgW: 0, imgH: 0 };
    const p1_pixel = { x: 0, y: 0 }, p2_pixel = { x: 0, y: 0 };
    const container = document.getElementById('canvas-container');
    const img = document.getElementById('mapImg');
    const msg = document.getElementById('msg');

    // 1. è®€å–åœ–ç‰‡
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            img.src = ev.target.result;
            img.onload = () => {
                state.imgW = img.naturalWidth; 
                state.imgH = img.naturalHeight;
                msg.innerText = "è«‹é»æ“Šï¼šP1 å®šä½é» (9200, -9560)";
                msg.style.color = "#ff4444";
                resetView();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function resetView() {
        state.scale = Math.min(window.innerWidth / state.imgW, window.innerHeight / state.imgH) * 0.8;
        state.x = (window.innerWidth - state.imgW * state.scale) / 2;
        state.y = (window.innerHeight - state.imgH * state.scale) / 2;
        updateTransform();
    }

    function updateTransform() {
        container.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    }

    // 2. ç¸®æ”¾èˆ‡å¹³ç§»
    document.getElementById('viewport').onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const mx = e.clientX, my = e.clientY;
        const ix = (mx - state.x) / state.scale;
        const iy = (my - state.y) / state.scale;
        state.scale *= delta;
        state.x = mx - ix * state.scale;
        state.y = my - iy * state.scale;
        updateTransform();
    };

    let isDrag = false, sx, sy, moved = false;
    document.getElementById('viewport').onmousedown = (e) => { isDrag = true; sx = e.clientX; sy = e.clientY; moved = false; };
    window.onmousemove = (e) => {
        if (!isDrag) return;
        const dx = e.clientX - sx;
        const dy = e.clientY - sy;
        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) moved = true;
        state.x += dx; state.y += dy;
        sx = e.clientX; sy = e.clientY;
        updateTransform();
    };

    // 3. é»æ“Šæ¨™è¨˜
    window.onmouseup = (e) => {
        if (!moved && isDrag && state.imgW > 0 && state.step <= 2) {
            const px = (e.clientX - state.x) / state.scale;
            const py = (e.clientY - state.y) / state.scale;
            
            const dot = document.createElement('div');
            dot.className = 'marker m' + state.step;
            dot.style.left = px + 'px';
            dot.style.top = py + 'px';
            document.getElementById('markers').appendChild(dot);

            if (state.step === 1) {
                p1_pixel.x = px; p1_pixel.y = py;
                state.step = 2;
                msg.innerText = "è«‹é»æ“Šï¼šP2 å®šä½é» (-1700, -230)";
                msg.style.color = "#4488ff";
            } else {
                p2_pixel.x = px; p2_pixel.y = py;
                state.step = 3;
                calculate();
            }
        }
        isDrag = false;
    };

    // 4. æ ¸å¿ƒè¨ˆç®—
    function calculate() {
        const g1 = { x: parseFloat(document.getElementById('p1x').value), y: parseFloat(document.getElementById('p1y').value) };
        const g2 = { x: parseFloat(document.getElementById('p2x').value), y: parseFloat(document.getElementById('p2y').value) };

        // è¨ˆç®—æ¯”ä¾‹ (Game units per Pixel)
        const scaleX = (g2.x - g1.x) / (p2_pixel.x - p1_pixel.x);
        const scaleY = (g2.y - g1.y) / (p2_pixel.y - p1_pixel.y);

        // è¨ˆç®—åœ–ç‰‡å››è§’çš„éŠæˆ²åº§æ¨™
        const minX = g1.x - p1_pixel.x * scaleX;
        const minY = g1.y - p1_pixel.y * scaleY;
        const maxX = minX + state.imgW * scaleX;
        const maxY = minY + state.imgH * scaleY;

        const code = `const mapSettings = {
    imageName: "map_bg.jpg",
    minX: ${Math.round(minX)},
    maxX: ${Math.round(maxX)},
    minY: ${Math.round(minY)},
    maxY: ${Math.round(maxY)}
};`;
        document.getElementById('output').innerText = code;
        document.getElementById('result').style.display = 'block';
        msg.innerText = "âœ… æ ¡æº–è¨ˆç®—å®Œæˆï¼";
        msg.style.color = "#00ff00";
    }

    function copyCode() {
        const text = document.getElementById('output').innerText;
        navigator.clipboard.writeText(text).then(() => alert("ä»£ç¢¼å·²è¤‡è£½ï¼è«‹è²¼åˆ° config.js ä¸­ã€‚"));
    }
</script>
</body>
</html>
