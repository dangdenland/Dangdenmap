<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–æ ¡æ­£å·¥å…· v3.0 (å°é½Šç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; }
        #map { height: 100vh; width: 100vw; background-color: #333; }

        /* é¢æ¿æ¨£å¼ */
        #panel {
            position: fixed; top: 10px; right: 10px; z-index: 9999;
            background: rgba(0, 0, 0, 0.9); color: #fff; padding: 15px;
            border-radius: 8px; width: 320px; font-size: 14px;
            border: 1px solid #666; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        h2 { margin: 0 0 10px 0; color: #ffcc00; font-size: 18px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        
        .control-group { margin-bottom: 15px; background: #222; padding: 10px; border-radius: 4px; border: 1px solid #444; }
        .group-title { font-weight: bold; color: #4db8ff; margin-bottom: 5px; display: block; }
        .desc { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        
        .key-hint { display: inline-block; padding: 2px 6px; background: #555; border-radius: 3px; font-family: monospace; color: #fff; border: 1px solid #777; font-size: 12px; }

        .btn-copy {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px;
        }
        .btn-copy:hover { background-color: #218838; }

        .status-row { display: flex; justify-content: space-between; font-family: monospace; font-size: 12px; color: #888; margin-top: 5px; }
        
        /* è®“åœ“é»æ›´æ˜é¡¯ */
        .leaflet-marker-icon { opacity: 0.9 !important; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h2>ğŸ› ï¸ åœ°åœ–å°é½Šå·¥å…· v3.0</h2>

    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 1: å°é½Šå·¦ä¸Šè§’ (å¹³ç§»)</span>
        <div class="desc">æ‰¾ä¸€å€‹é <b>å·¦ä¸Šè§’</b>çš„æ‘èŠ (å¦‚: æ±ç”°)</div>
        <div class="desc">ä½¿ç”¨ <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> ç§»å‹•æ•´å¼µåº•åœ–</div>
        <div class="desc" style="color:#ff6b6b">ç›®æ¨™ï¼šè®“è©²æ‘èŠèˆ‡åœ“é»é‡åˆ</div>
    </div>

    <div class="control-group">
        <span class="group-title">æ­¥é©Ÿ 2: å°é½Šå³ä¸‹è§’ (æ‹‰ä¼¸)</span>
        <div class="desc">æ‰¾ä¸€å€‹é <b>å³ä¸‹è§’</b>çš„æ‘èŠ (å¦‚: ç£å…§)</div>
        <div class="desc">ä½¿ç”¨ <span class="key-hint">â¬†ï¸</span> <span class="key-hint">â¬‡ï¸</span> <span class="key-hint">â¬…ï¸</span> <span class="key-hint">â¡ï¸</span> æ‹‰ä¼¸åº•åœ–é‚Šç·£</div>
        <div class="desc" style="color:#ff6b6b">ç›®æ¨™ï¼šå·¦ä¸Šè§’ä¸å‹•ï¼Œè®“å³ä¸‹è§’é‡åˆ</div>
    </div>

    <div class="control-group">
        <span class="group-title">å¾®èª¿é€Ÿåº¦</span>
        <input type="range" id="speedRange" min="1" max="100" value="20" style="width:100%">
        <div style="text-align:right; font-size:12px;" id="speedVal">20 px</div>
        <div class="desc">æŒ‰ä½ <span class="key-hint">Shift</span> å¯åŠ é€Ÿ 5 å€</div>
    </div>

    <button class="btn-copy" onclick="copyConfig()">âœ… å®Œæˆï¼è¤‡è£½ä»£ç¢¼</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    if (typeof mapSettings === 'undefined') {
        // é˜²å‘†é è¨­å€¼ (å¦‚æœè®€ä¸åˆ° config.js)
        var mapSettings = { imageName: "map_bg.png", minX: -2560, maxX: 9359, minY: -9728, maxY: 1023 };
    }

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 2, zoomSnap: 0.1, attributionControl: false, zoomControl: false
    });
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // ç¹ªè£½æ‘èŠåƒè€ƒé» (ç´…é»)
    const bounds = [];
    if (typeof rawData !== 'undefined') {
        rawData.forEach(v => {
            const latLng = [-v.y, v.x];
            bounds.push(latLng);
            L.circleMarker(latLng, {
                radius: 3, color: 'red', fillColor: '#ff0000', fillOpacity: 1, weight: 1
            }).bindTooltip(v.name, {permanent: true, direction: 'right', offset:[5,0], opacity:0.8}).addTo(map);
        });
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [100, 100] });
    }

    // ç•¶å‰è¨­å®šç‹€æ…‹
    let current = {
        minX: mapSettings.minX,
        maxX: mapSettings.maxX,
        minY: mapSettings.minY,
        maxY: mapSettings.maxY
    };

    // å»ºç«‹åº•åœ–
    let mapImageLayer = L.imageOverlay(
        mapSettings.imageName, 
        [[-current.minY, current.minX], [-current.maxY, current.maxX]], 
        { opacity: 0.6, zIndex: -1 } // åŠé€æ˜
    );
    mapImageLayer.addTo(map);

    // æ›´æ–°ç•«é¢
    function render() {
        // æ›´æ–°åœ–ç‰‡ä½ç½®
        mapImageLayer.setBounds([[-current.minY, current.minX], [-current.maxY, current.maxX]]);
    }

    // éµç›¤æ§åˆ¶é‚è¼¯
    document.addEventListener('keydown', (e) => {
        let step = parseInt(document.getElementById('speedRange').value);
        if (e.shiftKey) step *= 5; // æŒ‰ Shift åŠ é€Ÿ

        // 1. WASD å¹³ç§» (Move Whole Map)
        // åŒæ™‚æ”¹è®Š Min å’Œ Maxï¼Œä¿æŒå¯¬é«˜ä¸è®Šï¼Œåªæ”¹è®Šä½ç½®
        if (e.code === 'KeyW') { // ä¸Šç§» (Y è®Šå° -> Lat è®Šå¤§) -> éŠæˆ²åº§æ¨™ Y æ¸›å° (å› ç‚º Lat = -Y)
            current.minY -= step; current.maxY -= step; render();
        }
        if (e.code === 'KeyS') { // ä¸‹ç§»
            current.minY += step; current.maxY += step; render();
        }
        if (e.code === 'KeyA') { // å·¦ç§»
            current.minX -= step; current.maxX -= step; render();
        }
        if (e.code === 'KeyD') { // å³ç§»
            current.minX += step; current.maxX += step; render();
        }

        // 2. æ–¹å‘éµ æ‹‰ä¼¸ (Stretch)
        // å›ºå®šå·¦ä¸Šè§’ (MinX, MinY ä¸å‹•)ï¼Œåªæ”¹è®Šå³ä¸‹è§’ (MaxX, MaxY)
        if (e.code === 'ArrowUp') { // æ”¶ç¸®é«˜åº¦
            current.maxY -= step; render();
        }
        if (e.code === 'ArrowDown') { // æ‹‰é•·é«˜åº¦
            current.maxY += step; render();
        }
        if (e.code === 'ArrowLeft') { // æ”¶ç¸®å¯¬åº¦
            current.maxX -= step; render();
        }
        if (e.code === 'ArrowRight') { // æ‹‰é•·å¯¬åº¦
            current.maxX += step; render();
        }
    });

    // é€Ÿåº¦æ»‘æ¡¿é¡¯ç¤º
    document.getElementById('speedRange').addEventListener('input', function(e) {
        document.getElementById('speedVal').innerText = e.target.value + " px";
    });

    // è¤‡è£½ä»£ç¢¼
    window.copyConfig = function() {
        const code = `// ==========================================
// ğŸŒ åœ°åœ–è¨­å®šæª” (æ ¡æ­£å®Œæˆ)
// ==========================================

const mapSettings = {
    imageName: "${mapSettings.imageName}",
    
    minX: ${current.minX},
    maxX: ${current.maxX},
    minY: ${current.minY},
    maxY: ${current.maxY}
};`;

        navigator.clipboard.writeText(code).then(() => {
            alert("âœ… ä»£ç¢¼å·²è¤‡è£½ï¼è«‹è¦†è“‹ config.js çš„å…§å®¹");
        }).catch(() => {
            console.log(code);
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹çœ‹ Console");
        });
    }
</script>

</body>
</html>
