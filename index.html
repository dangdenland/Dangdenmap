<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‘èŠåœ°åœ– | v7.5 å°ˆæ¥­ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.82);
            --glass-border: rgba(255, 255, 255, 0.3);
            --primary-accent: #2563eb;
            --text-main: #1e293b;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', "Microsoft JhengHei", sans-serif; background: #0f172a; overflow: hidden; }
        
        #map { height: 100vh; width: 100vw; background: #1e293b; }

        /* 2025 æ‡¸æµ®å¡ç‰‡é¢æ¿ */
        .floating-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 320px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none; /* è®“èƒŒæ™¯åœ°åœ–èƒ½è¢«çœ‹åˆ° */
        }

        .floating-panel > * { pointer-events: auto; } /* æ¢å¾©å¡ç‰‡é»æ“Š */

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨è³‡è¨Šå¡ */
        .header-card { flex-shrink: 0; }
        .header-card h1 { margin: 0; font-size: 18px; color: var(--text-main); font-weight: 800; }
        .version-info { font-family: monospace; font-size: 11px; color: #64748b; margin-top: 4px; }

        /* æŒ‰éˆ•é¢¨æ ¼ */
        .btn-modern {
            background: var(--primary-accent);
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            display: block;
            margin-top: 10px;
        }
        .btn-modern:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* è¡Œæ”¿å€åŠƒé•·åˆ—è¡¨ - å„ªåŒ– iPad æ²å‹• */
        .scroll-card {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 700;
            margin: 15px 0 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 4px;
        }

        /* åœ–ä¾‹æ¨£å¼ */
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 13px; color: var(--text-main); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; margin-right: 10px; flex-shrink: 0; }
        .prov-name { font-weight: bold; color: var(--primary-accent); margin: 10px 0 5px 0; font-size: 12px; }

        /* åœ–å±¤æ§åˆ¶é¸å–®è¦†è“‹ */
        .leaflet-control-layers {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            margin: 0 !important;
        }
        .leaflet-control-layers-list { font-size: 13px; }

        /* æ¨™ç±¤ç¾åŒ– */
        .v-label-box {
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #1e293b;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.8);
        }

        /* iPad è¢å¹•å¯¬åº¦é©æ‡‰ */
        @media (max-width: 768px) {
            .floating-panel { width: 260px; right: 10px; top: 10px; bottom: 10px; }
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="floating-panel">
    <!-- é ‚éƒ¨è³‡è¨Šå¡ -->
    <div class="card header-card">
        <h1>ğŸ—ºï¸ æ‘èŠå°è¦½ç³»çµ±</h1>
        <div id="version-display" class="version-info">åµæ¸¬ç‰ˆæœ¬ä¸­...</div>
        <a href="changelog.html" target="_blank" class="btn-modern">ğŸ“œ æ›´æ–°æ—¥èªŒ</a>
    </div>

    <!-- åœ–å±¤å¡ -->
    <div class="card">
        <div class="section-label">åœ–å±¤åˆ‡æ›</div>
        <div id="layer-control-target"></div>
    </div>

    <!-- è¡Œæ”¿å€åŠƒå¡ -->
    <div class="card scroll-card">
        <div class="section-label">è¡Œæ”¿å€åŠƒåœ–ä¾‹</div>
        <div class="scroll-area" id="legend-target"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    // --- [1] åº§æ¨™é‚è¼¯ä¿®æ­£ (Minecraft $Z$ å¢åŠ  = åœ°åœ–å‘ä¸‹ï¼Œæ•… $Y = -v.y$) ---
    var cfg = (typeof mapSettings !== 'undefined') ? mapSettings : { minX: -5000, maxX: 10000, minY: -10000, maxY: 1000 };
    var vData = (typeof rawData !== 'undefined') ? rawData : [];
    
    // åˆå§‹åŒ–åœ°åœ–
    var map = L.map('map', { 
        crs: L.CRS.Simple, minZoom: -4, maxZoom: 4, zoomSnap: 0.1, 
        attributionControl: false, zoomControl: false 
    });

    // --- [2] åœ–å±¤èˆ‡åœ°å½¢åœ– (ä¿®æ­£å—åŒ—å‘) ---
    // Minecraft minY æ˜¯åŒ—ç•Œï¼Œä½†åœ¨ Leaflet åº§æ¨™ç³»ä¸­åŒ—ç•Œæ˜¯æ­£æ•¸ï¼Œæ•…å–è² è™Ÿå¾Œå°èª¿
    var imageBounds = [[-cfg.maxY, cfg.minX], [-cfg.minY, cfg.maxX]];
    var mapImg = L.imageOverlay(cfg.imageName, imageBounds, { opacity: 1 }).addTo(map);

    var villageLayer = L.layerGroup().addTo(map);
    var labelLayer = L.layerGroup().addTo(map);
    var railLayer = L.layerGroup().addTo(map);
    var gridLayer = L.layerGroup();

    // --- [3] æ•¸æ“šè™•ç† ---
    var coordMap = {};
    var hierarchy = {};
    vData.forEach(function(v) {
        var pos = [-v.y, v.x]; // é‡è¦ï¼šMinecraft Y è»¸åè½‰
        coordMap[v.name] = pos;
        if (!hierarchy[v.prov]) hierarchy[v.prov] = {};
        if (!hierarchy[v.prov][v.county]) hierarchy[v.prov][v.county] = new Set();
        hierarchy[v.prov][v.county].add(v.dist || "ç›´è½„");
    });

    // é¡è‰²è¨ˆç®—
    var districtColors = {};
    Object.keys(hierarchy).forEach(prov => {
        Object.keys(hierarchy[prov]).forEach(county => {
            var districts = Array.from(hierarchy[prov][county]);
            var hue = (typeof countyHues !== 'undefined' && countyHues[county] !== undefined) ? countyHues[county] : 200;
            districts.forEach((dist, i) => {
                var l = districts.length > 1 ? (40 + (i / (districts.length-1)) * 30) : 50;
                districtColors[county + "-" + dist] = (hue === -1) ? "#94a3b8" : `hsl(${hue}, 75%, ${l}%)`;
            });
        });
    });

    // --- [4] ç¹ªè£½æ¨™è¨˜ ---
    vData.forEach(function(v) {
        var pos = [-v.y, v.x];
        var color = districtColors[v.county + "-" + (v.dist || "ç›´è½„")] || "#fff";
        
        L.circleMarker(pos, { radius: 6, fillColor: color, color: "#0f172a", weight: 2, fillOpacity: 1 })
         .bindPopup(`<b>${v.name}</b><br>${v.prov}çœ ${v.county}ç¸£<br>X: ${v.x}, Z: ${v.y}`)
         .addTo(villageLayer);

        L.marker(pos, {
            icon: L.divIcon({ className: '', html: `<div class="v-label-box">${v.name}</div>`, iconAnchor: [0, -10] })
        }).addTo(labelLayer);
    });

    // éµè·¯
    if (typeof railwayRoutesData !== 'undefined') {
        function drawR(routes, style, layer) {
            routes.forEach(r => {
                var pts = r.split("-").map(name => coordMap[name]).filter(p => p);
                if (pts.length > 1) L.polyline(pts, style).addTo(layer);
            });
        }
        drawR(railwayRoutesData.completed, { color: "#1e293b", weight: 4, opacity: 0.8 }, railLayer);
        drawR(railwayRoutesData.construction, { color: "#f59e0b", weight: 3, opacity: 0.6, dashArray: "8, 8" }, railLayer);
    }

    // --- [5] UI çµ„ä»¶ç”Ÿæˆ ---
    // åœ–å±¤é¸å–®
    var layers = L.control.layers(
        { "è¡›æ˜Ÿåœ°å½¢": mapImg, "ç°¡æ½”ç©ºç™½": L.layerGroup() },
        { "æ‘èŠé»ä½": villageLayer, "åç¨±æ¨™ç±¤": labelLayer, "éµè·¯è·¯ç·š": railLayer, "åº§æ¨™æ ¼ç·š": gridLayer },
        { collapsed: false }
    ).addTo(map);
    document.getElementById('layer-control-target').appendChild(layers.getContainer());

    // åœ–ä¾‹
    var legHtml = "";
    Object.keys(hierarchy).forEach(prov => {
        legHtml += `<div class="prov-name">${prov}çœ</div>`;
        Object.keys(hierarchy[prov]).forEach(county => {
            hierarchy[prov][county].forEach(dist => {
                var color = districtColors[county + "-" + dist];
                legHtml += `<div class="legend-item"><div class="legend-dot" style="background:${color}"></div>${county}ç¸£ ${dist === 'ç›´è½„' ? '(ç›´è½„)' : dist + 'éƒ¡'}</div>`;
            });
        });
    });
    document.getElementById('legend-target').innerHTML = legHtml;

    // --- [6] åœ°åœ–åˆå§‹åŒ–èˆ‡ç‰ˆæœ¬ ---
    map.fitBounds(imageBounds);
    
    (async function() {
        const display = document.getElementById('version-display');
        try {
            const host = window.location.hostname;
            if (host.includes('github.io')) {
                const parts = window.location.pathname.split('/');
                const res = await fetch(`https://api.github.com/repos/${host.split('.')[0]}/${parts[1]}/commits?per_page=1`);
                const data = await res.json();
                display.innerText = "æœ€å¾Œæ›´æ–°: " + new Date(data[0].commit.committer.date).toLocaleString('zh-TW');
            } else {
                display.innerText = "æœ¬åœ°é–‹ç™¼æ¨¡å¼ | " + (cfg.version || "Alpha");
            }
        } catch (e) { display.innerText = "ç„¡æ³•è®€å–ç‰ˆæœ¬è³‡è¨Š"; }
    })();
</script>
</body>
</html>
