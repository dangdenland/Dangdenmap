<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‘èŠåœ°åœ– - ç©©å®šä¿®å¾©ç‰ˆ v7.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --sidebar-width: 300px;
            --primary-color: #2c3e50;
            --accent-color: #d35400;
        }
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; display: flex; }
        
        /* åœ°åœ–å€åŸŸ */
        #map { height: 100vh; flex-grow: 1; background: #f0f0f0; }

        /* å³å´å´é‚Šæ¬„ */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            border-left: 1px solid #ccc;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
        }
        .sidebar-header h3 { margin: 0; font-size: 18px; }
        
        .sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: thin;
        }

        /* å€å¡Šæ¨£å¼ */
        .section-title {
            font-weight: bold;
            font-size: 14px;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-link {
            display: block;
            text-align: center;
            background: var(--accent-color);
            color: white;
            text-decoration: none;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 10px;
            transition: opacity 0.2s;
        }
        .btn-link:hover { opacity: 0.8; }

        /* ç‰ˆæœ¬è³‡è¨Š */
        .version-info {
            font-family: monospace;
            font-size: 11px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            color: #666;
        }

        /* è‡ªå®šç¾©åœ–å±¤é¸å–®æ¨£å¼ */
        .leaflet-control-layers {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            background: #fff !important;
            margin: 0 !important;
            width: 100%;
            position: relative !important;
            float: none !important;
        }
        
        /* åœ–ä¾‹æ¨£å¼ */
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 13px; }
        .legend-color { width: 14px; height: 14px; margin-right: 8px; border-radius: 50%; border: 1px solid #666; flex-shrink: 0; }
        .prov-tag { font-weight: bold; color: var(--accent-color); margin-top: 10px; font-size: 13px; }

        /* æ¨™ç±¤æ¨£å¼ */
        .village-label-content { 
            position: absolute; transform: translate(-50%, -50%); 
            font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.9); 
            padding: 2px 6px; border: 1px solid #666; border-radius: 3px; white-space: nowrap;
        }
        .grid-label { font-size: 10px; color: #999; }

        /* iPad é©æ‡‰æ€§ä¿®æ­£ */
        @media (max-width: 768px) {
            :root { --sidebar-width: 240px; }
            .sidebar-header h3 { font-size: 16px; }
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <div class="sidebar-header">
        <h3>ğŸ—ºï¸ æ‘èŠåœ°åœ–å°èˆª</h3>
    </div>
    <div class="sidebar-content">
        <a href="changelog.html" target="_blank" class="btn-link">ğŸ“œ æŸ¥çœ‹æ›´æ–°ç´€éŒ„</a>
        
        <div class="section-title">ğŸ“Œ ç‰ˆæœ¬è³‡è¨Š</div>
        <div id="version-display" class="version-info">æ­£åœ¨å–å¾—è³‡è¨Š...</div>

        <div class="section-title">ğŸ› ï¸ åœ–å±¤åˆ‡æ›</div>
        <div id="layer-control-container"></div>

        <div class="section-title">ğŸ˜ï¸ è¡Œæ”¿å€åŠƒ</div>
        <div id="legend-content"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    // --- [1] åˆå§‹åŒ–èˆ‡è³‡æ–™æ ¡æº– ---
    var cfg = (typeof mapSettings !== 'undefined') ? mapSettings : { imageName: "map_bg.jpg", minX: -2000, maxX: 10000, minY: -10000, maxY: 1000 };
    var vData = (typeof rawData !== 'undefined') ? rawData : [];
    var hues = (typeof countyHues !== 'undefined') ? countyHues : {};
    var rwData = (typeof railwayRoutesData !== 'undefined') ? railwayRoutesData : { completed: [], construction: [] };

    // åˆå§‹åŒ–åœ°åœ– (ä½¿ç”¨ CRS.Simple)
    var map = L.map('map', { 
        crs: L.CRS.Simple, 
        minZoom: -3, 
        maxZoom: 3, 
        zoomSnap: 0.1, 
        attributionControl: false,
        zoomControl: true 
    });

    // --- [2] åœ–å±¤å®šç¾© ---
    var terrainLayer = L.imageOverlay(cfg.imageName, [[cfg.minY, cfg.minX], [cfg.maxY, cfg.maxX]], { opacity: 0.9 }).addTo(map);
    var villageLayer = L.layerGroup().addTo(map);
    var labelLayer = L.layerGroup().addTo(map);
    var gridLayer = L.layerGroup();
    var railwayLayer = L.layerGroup().addTo(map);
    var railUnderConstLayer = L.layerGroup().addTo(map);

    // --- [3] è™•ç†è¡Œæ”¿å€é¡è‰²èˆ‡åº§æ¨™ ---
    var coordMap = {};
    var hierarchy = {};
    vData.forEach(function(v) {
        coordMap[v.name] = [v.y, v.x]; // ä½¿ç”¨æ¨™æº– [y, x]
        if (!hierarchy[v.prov]) hierarchy[v.prov] = {};
        if (!hierarchy[v.prov][v.county]) hierarchy[v.prov][v.county] = new Set();
        hierarchy[v.prov][v.county].add(v.dist || "ç›´è½„");
    });

    var districtColors = {};
    Object.keys(hierarchy).forEach(function(prov) {
        Object.keys(hierarchy[prov]).forEach(function(county) {
            var districts = Array.from(hierarchy[prov][county]).sort();
            var baseHue = (hues[county] !== undefined) ? hues[county] : 0;
            districts.forEach(function(dist, index) {
                var key = county + "-" + dist;
                var lightness = (districts.length > 1) ? (40 + (index / (districts.length - 1)) * 30) : 55;
                districtColors[key] = (baseHue === -1) ? "#7f8c8d" : "hsl(" + baseHue + ", 70%, " + lightness + "%)";
            });
        });
    });

    // --- [4] ç¹ªè£½åŠŸèƒ½ ---
    function drawLines(routes, style, layer) {
        if (!routes) return;
        routes.forEach(function(routeStr) {
            var stations = routeStr.split("-");
            var latLngs = [];
            stations.forEach(function(name) { if (coordMap[name]) latLngs.push(coordMap[name]); });
            if (latLngs.length > 1) L.polyline(latLngs, style).addTo(layer);
        });
    }

    var labelObjects = [];
    vData.forEach(function(v) {
        var pos = [v.y, v.x];
        var distKey = v.county + "-" + (v.dist || "ç›´è½„");
        var color = districtColors[distKey] || "#333";
        
        var popupHtml = "<b>" + v.name + "</b><br>" + v.prov + "çœ " + v.county + "ç¸£<br>åº§æ¨™: " + v.x + ", " + v.y;
        
        L.circleMarker(pos, { radius: 5, fillColor: color, color: "#000", weight: 1, fillOpacity: 1 }).bindPopup(popupHtml).addTo(villageLayer);

        var label = L.marker(pos, {
            icon: L.divIcon({ className: 'v-label', html: '<div class="village-label-content">' + v.name + '</div>', iconSize: [0, 0] })
        }).addTo(labelLayer);
        
        labelObjects.push({ marker: label, origin: pos });
    });

    drawLines(rwData.completed, { color: '#2c3e50', weight: 3, opacity: 0.8 }, railwayLayer);
    drawLines(rwData.construction, { color: '#e67e22', weight: 3, opacity: 0.7, dashArray: '5, 8' }, railUnderConstLayer);

    function drawGrid() {
        gridLayer.clearLayers();
        var z = map.getZoom();
        var step = z >= 0 ? 500 : 1000;
        for (var x = Math.floor(cfg.minX/step)*step; x <= cfg.maxX; x += step) {
            L.polyline([[cfg.minY, x], [cfg.maxY, x]], { color: '#aaa', weight: 0.5, opacity: 0.3 }).addTo(gridLayer);
            L.marker([cfg.maxY, x], { icon: L.divIcon({ className: 'grid-label', html: x, iconAnchor: [0,0] }) }).addTo(gridLayer);
        }
        for (var y = Math.floor(cfg.minY/step)*step; y <= cfg.maxY; y += step) {
            L.polyline([[y, cfg.minX], [y, cfg.maxX]], { color: '#aaa', weight: 0.5, opacity: 0.3 }).addTo(gridLayer);
            L.marker([y, cfg.minX], { icon: L.divIcon({ className: 'grid-label', html: y, iconAnchor: [0,0] }) }).addTo(gridLayer);
        }
    }

    // --- [5] UI æ•´åˆ ---
    // åœ–å±¤é¸å–®ç§»å…¥å´é‚Šæ¬„
    var layerControl = L.control.layers(
        { "åœ°å½¢èƒŒæ™¯": terrainLayer, "ç´”ç™½èƒŒæ™¯": L.layerGroup() },
        { "æ‘èŠé»ä½": villageLayer, "åç¨±æ¨™ç±¤": labelLayer, "æ ¼ç·š": gridLayer, "éµè·¯ (ç‡Ÿé‹ä¸­)": railwayLayer, "éµè·¯ (èˆˆå»ºä¸­)": railUnderConstLayer },
        { collapsed: false }
    ).addTo(map);
    document.getElementById('layer-control-container').appendChild(layerControl.getContainer());

    // ç”Ÿæˆåœ–ä¾‹
    var lgd = document.getElementById('legend-content');
    Object.keys(hierarchy).forEach(function(prov) {
        var pDiv = document.createElement('div');
        pDiv.className = 'prov-tag';
        pDiv.innerText = prov + "çœ";
        lgd.appendChild(pDiv);
        Object.keys(hierarchy[prov]).forEach(function(county) {
            Array.from(hierarchy[prov][county]).forEach(function(dist) {
                var color = districtColors[county + "-" + dist];
                var item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = '<i class="legend-color" style="background:' + color + '"></i>' + county + 'ç¸£ ' + (dist === 'ç›´è½„' ? '(ç›´è½„)' : dist + 'éƒ¡');
                lgd.appendChild(item);
            });
        });
    });

    // --- [6] åˆå§‹åŒ–åœ°åœ–ä½ç½® ---
    var group = new L.featureGroup(labelObjects.map(o => o.marker));
    map.fitBounds(group.getBounds().pad(0.1));
    drawGrid();

    map.on('zoomend', drawGrid);

    // --- [7] ç‰ˆæœ¬åµæ¸¬ ---
    (async function() {
        var el = document.getElementById('version-display');
        try {
            var host = window.location.hostname;
            if (host.includes('github.io')) {
                var pathParts = window.location.pathname.split('/');
                var user = host.split('.')[0];
                var repo = pathParts[1];
                var res = await fetch(`https://api.github.com/repos/${user}/${repo}/commits?per_page=1`);
                if (res.ok) {
                    var data = await res.json();
                    var date = new Date(data[0].commit.committer.date);
                    el.innerText = "æœ€å¾Œæ›´æ–°: " + date.toLocaleString('zh-TW', { hour12: false });
                    return;
                }
            }
            el.innerText = "æœ¬åœ°æ¸¬è©¦æ¨¡å¼ (v7.0)\nConfig: " + (cfg.version || "N/A");
        } catch (e) { el.innerText = "ç„¡æ³•é€£ç·šè‡³ GitHub å–å¾—ç‰ˆæœ¬"; }
    })();
</script>
</body>
</html>
