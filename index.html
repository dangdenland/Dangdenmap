<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘èŠåœ°åœ– (æ ¡æ­£æ¨¡å¼)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        #map { height: 100vh; width: 100vw; background-color: #f5f5f5; }
        
        /* åœ–ä¾‹æ¨£å¼ */
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px 15px; border-radius: 5px; border: 1px solid #bbb; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; max-height: 60vh; overflow-y: auto; line-height: 1.5; -webkit-overflow-scrolling: touch; }
        .legend h4 { margin: 0 0 8px 0; font-size: 15px; border-bottom: 2px solid #666; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color { width: 16px; height: 16px; margin-right: 8px; border-radius: 50%; border: 1px solid #666; flex-shrink: 0; }
        .legend-line { width: 20px; height: 3px; margin-right: 8px; display: inline-block; vertical-align: middle; }
        
        /* æ¨™ç±¤èˆ‡å½ˆçª— */
        .grid-label { font-size: 10px; color: #999; white-space: nowrap; }
        .village-label-wrapper { background: transparent; border: none; }
        .village-label-content { 
            position: absolute; left: 0; top: 0; transform: translate(-50%, -50%); 
            display: inline-block; width: max-content; min-width: 40px; box-sizing: border-box; 
            font-size: 12px; font-weight: bold; color: #000; background-color: #fff; 
            padding: 4px 8px; border: 1px solid #666; border-radius: 4px; 
            white-space: nowrap; text-align: center; box-shadow: 1px 1px 4px rgba(0,0,0,0.2); 
            cursor: move; z-index: 10; user-select: none; -webkit-user-select: none; 
        }
        .village-label-content:hover { background-color: #f0f8ff; border-color: #007bff; z-index: 20; }
        .leaflet-popup-content { font-size: 14px; line-height: 1.6; }

        /* æ ¡æ­£é¢æ¿æ¨£å¼ */
        #calibration-panel {
            position: fixed; bottom: 20px; left: 20px; z-index: 9999;
            background: rgba(0, 0, 0, 0.8); color: #fff; padding: 15px;
            border-radius: 8px; width: 220px; font-size: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #calibration-panel h4 { margin: 0 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px; color: #ffcc00; }
        .cal-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .cal-row input { width: 80px; padding: 2px; text-align: right; }
        
        /* åˆ—å°è¨­å®š */
        @media print { 
            .leaflet-control-container, #calibration-panel { display: none !important; } 
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
            .legend { position: absolute; bottom: 20px; right: 20px; box-shadow: none; border: 1px solid #000; } 
            #map { height: 100%; width: 100%; } 
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- æ ¡æ­£é¢æ¿ -->
<div id="calibration-panel" style="display:none;">
    <h4>ğŸ—ºï¸ åœ°åœ–åº•åœ–æ ¡æ­£å™¨</h4>
    <div class="cal-row"><label>ä¸Šé‚Šç•Œ(Y):</label><input type="number" id="in-top" step="50"></div>
    <div class="cal-row"><label>ä¸‹é‚Šç•Œ(Y):</label><input type="number" id="in-bottom" step="50"></div>
    <div class="cal-row"><label>å·¦é‚Šç•Œ(X):</label><input type="number" id="in-left" step="50"></div>
    <div class="cal-row"><label>å³é‚Šç•Œ(X):</label><input type="number" id="in-right" step="50"></div>
    <div style="margin-top:8px; color:#ccc;">
        å°é½Šå¾Œè«‹è¨˜ä¸‹æ•¸å€¼<br>å¡«å› mapConfig ä¸¦é—œé–‰æ ¡æ­£æ¨¡å¼
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ==========================================
    // ğŸ”§ è¨­å®šå€ (å·²å¡«å…¥æ‚¨æä¾›çš„æ–°æ•¸å€¼)
    // ==========================================
    const mapConfig = {
        // 1. å…ˆé–‹å•Ÿæ ¡æ­£æ¨¡å¼ï¼Œç¢ºèªå°é½Š
        calibrationMode: true, 

        // 2. åœ–ç‰‡æª”å
        imageUrl: 'map_bg.png',

        // 3. åˆå§‹åƒæ•¸ (æ ¹æ“šæ‚¨æä¾›çš„ X: -2560~9359, Y: -9728~1023)
        // é€™äº›æ•¸å€¼æ˜¯ã€ŒéŠæˆ²åº§æ¨™ã€ï¼Œç¨‹å¼æœƒè‡ªå‹•è™•ç† Y è»¸ç¿»è½‰
        topY: -9728,    // åœ–ç‰‡é ‚éƒ¨ (Game Y)
        bottomY: 1023,  // åœ–ç‰‡åº•éƒ¨ (Game Y)
        leftX: -2560,   // åœ–ç‰‡å·¦å´ (Game X)
        rightX: 9359    // åœ–ç‰‡å³å´ (Game X)
    };
    // ==========================================

    // ==========================================
    // ğŸ“ è³‡æ–™å€
    // ==========================================
    const rawData = [
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 1, name: "æ±ç”°", x: -751, y: -172 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 2, name: "èµ¤æ¨¹", x: -131, y: -254 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 3, name: "ä¸­å³¶", x: -1307, y: -343 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ¾³å£", id: 4, name: "ä¸­æ¾³", x: -1531, y: -1010 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 5, name: "å¤§ç”°", x: 148, y: 175 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 6, name: "æ±æ¹–", x: 52, y: 30 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 7, name: "æ±ä»", x: -16, y: 73 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 8, name: "ç£å…§", x: 6259, y: -9041 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 9, name: "åŸ”é‡Œ", x: 6702, y: -8123 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å¤–åŸ”", dist: "å¤§å¯®", id: 10, name: "åŠ‰å", x: 2792, y: -3493 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 11, name: "å³¶ç”°", x: 8873, y: -9132 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 12, name: "é›ªç”°", x: 7533, y: -8616 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 13, name: "ç™½æºª", x: 6337, y: -8051 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 14, name: "å—åœ", x: 5220, y: -7424 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 15, name: "ä¸­æ¸¯", x: 3275, y: -6124 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å¤–åŸ”", dist: "å¤§å¯®", id: 16, name: "é ‚åº„", x: 2123, y: -3258 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å¤–åŸ”", dist: "å¤§å¯®", id: 17, name: "å´åº•å¯®", x: 1068, y: -2705 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æµ·é™½", id: 18, name: "ä¸­æ²™", x: 206, y: -1529 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æµ·é™½", id: 19, name: "èˆ¹é ­", x: 523, y: -1691 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "æ¸¯å—", dist: "èµ¤å³¶", id: 20, name: "èµ¤æ¸¯", x: 5173, y: -3848 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "æ¸¯å—", dist: "èµ¤å³¶", id: 21, name: "æµ·é ­", x: 5012, y: -3851 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "æ¸¯å—", dist: "èµ¤å³¶", id: 22, name: "å±±å´", x: 5198, y: -3754 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "æµ·å¶¼", id: 23, name: "æ·¡æµ·", x: 2021, y: -5127 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "æµ·å¶¼", id: 24, name: "æ·¡æ°´", x: 1763, y: -5207 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "æµ·å¶¼", id: 25, name: "é«˜å´", x: 1096, y: -4776 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "æµ·å¶¼", id: 26, name: "ä¸‰æ´²", x: 2104, y: -5737 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æµ·é™½", id: 27, name: "å±±åŸ”", x: -82, y: -1005 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ¾³å£", id: 28, name: "æµ·åŸ", x: -799, y: -1174 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æµ·é™½", id: 29, name: "ä¾‹æ‘", x: 135, y: -1068 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å¤–åŸ”", dist: "å¤§å¯®", id: 30, name: "å››åˆé™¢", x: 2263, y: -3315 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 31, name: "é›ªé ­", x: 5984, y: -7511 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 32, name: "ä¸‰æ˜", x: 2114, y: -6354 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 33, name: "æ°¸è±", x: 3162, y: -6582 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 34, name: "åŸå—", x: 3165, y: -6379 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 35, name: "æ–°å±±", x: 3108, y: -6262 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 36, name: "é›ªåŸ", x: 7002, y: -7587 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 37, name: "æ–°ç¤¾", x: 4929, y: -6485 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "å—å®‰", dist: "æ±æ¨¹", id: 38, name: "å¤§æ¨¹", x: 13, y: 589 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "èˆŸå±±", dist: "å¤§è±", id: 39, name: "éƒ­æºª", x: 5298, y: -6043 },
        { prov: "ä¸­äº¬", pref: "å¤§æˆ", county: "é›ªå·", dist: "", id: 40, name: "å¤§å‘", x: 5412, y: -6864 },
        // --- æ–°å¢æ‘èŠ (æœªå®š) ---
        { prov: "æœªå®š", pref: "æœªå®š", county: "æœªå®š", dist: "", id: 901, name: "æ–°æ‘èŠ01", x: -1905, y: -1011 },
        { prov: "æœªå®š", pref: "æœªå®š", county: "æœªå®š", dist: "", id: 902, name: "æ–°æ‘èŠ02", x: -1872, y: -1779 },
        { prov: "æœªå®š", pref: "æœªå®š", county: "æœªå®š", dist: "", id: 903, name: "æ–°æ‘èŠ03", x: 3162, y: -2254 },
        { prov: "æœªå®š", pref: "æœªå®š", county: "æœªå®š", dist: "", id: 904, name: "æ–°æ‘èŠ04", x: 1318, y: 318 }
    ];

    // å¦‚æœæ‚¨æœ‰ railwayRoutesDataï¼Œè«‹ä¿ç•™ï¼›è‹¥ç„¡å‰‡ç”¨ç©ºé™£åˆ—
    if (typeof railwayRoutesData === 'undefined') {
        var railwayRoutesData = { completed: [], construction: [] };
    }
    // ==========================================

    const coordMap = {};
    rawData.forEach(v => {
        coordMap[v.name] = [-v.y, v.x]; 
    });

    const map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 3, zoomSnap: 0.5, attributionControl: false
    });

    // é¡è‰²é‚è¼¯ (æœªå®š = ç°è‰²)
    const countyHues = { "å—å®‰": 0, "é›ªå·": 210, "å¤–åŸ”": 120, "èˆŸå±±": 270, "æ¸¯å—": 35, "å¤§æ¹–": 180, "æœªå®š": -1 };
    
    const hierarchy = {};
    rawData.forEach(v => {
        if (!hierarchy[v.county]) hierarchy[v.county] = new Set();
        hierarchy[v.county].add(v.dist || "ç›´è½„");
    });
    const districtColors = {}; 
    Object.keys(hierarchy).forEach(county => {
        const districts = Array.from(hierarchy[county]).sort();
        const baseHue = countyHues[county] !== undefined ? countyHues[county] : 0;
        
        districts.forEach((dist, index) => {
            if (county === "æœªå®š") {
                districtColors[`${county}-${dist}`] = "#7f8c8d"; // ç°è‰²
            } else {
                const count = districts.length;
                let lightness = 50;
                if (count > 1) lightness = 35 + (index / (count - 1)) * 35; 
                districtColors[`${county}-${dist}`] = `hsl(${baseHue}, 80%, ${lightness}%)`;
            }
        });
    });

    // åœ–å±¤
    const villageLayer = L.layerGroup();
    const labelLayer = L.layerGroup(); 
    const leaderLineLayer = L.layerGroup();
    const gridLayer = L.layerGroup();
    const railwayLayer = L.layerGroup(); 
    const railwayConstructionLayer = L.layerGroup(); 

    // é‚Šç•Œè¨ˆç®—
    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
    rawData.forEach(v => {
        if (v.x < minX) minX = v.x; if (v.x > maxX) maxX = v.x;
        if (v.y < minY) minY = v.y; if (v.y > maxY) maxY = v.y;
    });
    const padding = 2000;
    const gridBounds = { minX: minX - padding, maxX: maxX + padding, minY: minY - padding, maxY: maxY + padding };

    // éµè·¯
    function drawRailways(routes, style, layer) {
        routes.forEach(routeStr => {
            const stations = routeStr.split("-");
            const latLngs = [];
            stations.forEach(name => {
                if (coordMap[name]) latLngs.push(coordMap[name]);
            });
            if (latLngs.length > 1) L.polyline(latLngs, style).addTo(layer);
        });
    }
    drawRailways(railwayRoutesData.completed, { color: '#333', weight: 3, opacity: 0.8, lineCap: 'round', lineJoin: 'round' }, railwayLayer);
    drawRailways(railwayRoutesData.construction, { color: '#e67e22', weight: 3, opacity: 0.8, dashArray: '5, 10', lineCap: 'round' }, railwayConstructionLayer);

    // æ‘èŠé»ä½
    const bounds = [];
    const labelObjects = []; 

    rawData.forEach(v => {
        const latLng = [-v.y, v.x];
        bounds.push(latLng);
        const distKey = v.dist || "ç›´è½„";
        const color = districtColors[`${v.county}-${distKey}`] || "#333";
        
        let linkHtml = "";
        if (v.mapUrl) {
            linkHtml = `<div style="margin-top:12px; text-align:center;"><a href="${v.mapUrl}" target="_blank" style="display: inline-block; text-decoration: none; background-color: #007bff; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; transition: background 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">æŸ¥çœ‹æ‘èŠè»Œé“åœ– âœ</a></div>`;
        }
        
        const locationText = (v.county === "æœªå®š") 
            ? `<span style="color:#999; font-style:italic;">(è¡Œæ”¿å€åŠƒæœªå®š)</span>`
            : `${v.prov}çœ ${v.pref}åºœ<br>${v.county}ç¸£ ${v.dist ? v.dist + 'éƒ¡' : '(ç›´è½„)'}`;

        const popupContent = `
            <div style="text-align:center; min-width: 160px;">
                <strong style="font-size:16px; display:block; margin-bottom:5px;">${v.name}</strong>
                <hr style="margin:5px 0; border:0; border-top:1px solid #ccc">
                <div style="color:#333; margin: 6px 0; line-height:1.5;">${locationText}</div>
                <div style="font-size:12px; color:#666;">åº§æ¨™: (${v.x}, ${v.y})</div>
                ${linkHtml}
            </div>`;
        
        const marker = L.circleMarker(latLng, { radius: 5, fillColor: color, color: "#333", weight: 1, opacity: 1, fillOpacity: 1 });
        marker.bindPopup(popupContent);
        villageLayer.addLayer(marker);

        const leaderLine = L.polyline([latLng, latLng], { color: '#555', weight: 1, opacity: 0.6, interactive: false });
        leaderLineLayer.addLayer(leaderLine);

        const labelMarker = L.marker(latLng, {
            icon: L.divIcon({ className: 'village-label-wrapper', html: `<div class="village-label-content">${v.name}</div>`, iconSize: [0, 0], iconAnchor: [0, 0] }),
            draggable: true, zIndexOffset: 1000 
        });
        labelMarker.bindPopup(popupContent);
        
        labelMarker.on('drag', function(e) {
            const currentLabelLatLng = e.target.getLatLng();
            const originalDotLatLng = latLng;
            const dist = map.distance(currentLabelLatLng, originalDotLatLng);
            if(dist < 10) leaderLine.setLatLngs([originalDotLatLng, originalDotLatLng]);
            else leaderLine.setLatLngs([originalDotLatLng, currentLabelLatLng]);
        });

        labelObjects.push({ marker: labelMarker, line: leaderLine, origin: latLng, x: 0, y: 0 });
        labelLayer.addLayer(labelMarker);
    });

    // è‡ªå‹•ä½ˆå±€
    function autoLayoutLabels() {
        const visibleLabels = labelObjects.map(obj => {
            const pt = map.latLngToContainerPoint(obj.marker.getLatLng());
            return { ...obj, x: pt.x, y: pt.y };
        });
        for(let k=0; k<20; k++) { 
            for(let i=0; i<visibleLabels.length; i++) {
                for(let j=i+1; j<visibleLabels.length; j++) {
                    const a = visibleLabels[i];
                    const b = visibleLabels[j];
                    const dx = a.x - b.x;
                    const dy = a.y - b.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 55) { 
                        const force = (55 - dist) / 2;
                        let angle = Math.atan2(dy, dx);
                        if(dist === 0) angle = Math.random() * Math.PI * 2;
                        a.x += Math.cos(angle) * force; a.y += Math.sin(angle) * force;
                        b.x -= Math.cos(angle) * force; b.y -= Math.sin(angle) * force;
                    }
                }
            }
        }
        visibleLabels.forEach(obj => {
            const newLatLng = map.containerPointToLatLng([obj.x, obj.y]);
            if(newLatLng.lat !== obj.origin.lat || newLatLng.lng !== obj.origin.lng) {
                obj.marker.setLatLng(newLatLng);
                obj.line.setLatLngs([obj.origin, newLatLng]);
            }
        });
    }
    map.whenReady(() => setTimeout(autoLayoutLabels, 300));

    // æ ¼ç·š
    function drawGrid() {
        gridLayer.clearLayers();
        const zoom = map.getZoom();
        let step = zoom >= 1 ? 100 : (zoom >= -1 ? 500 : (zoom >= -3 ? 1000 : (zoom >= -5 ? 2000 : 5000)));
        const startX = Math.floor(gridBounds.minX / step) * step;
        const endX = Math.ceil(gridBounds.maxX / step) * step;
        const startY = Math.floor(gridBounds.minY / step) * step;
        const endY = Math.ceil(gridBounds.maxY / step) * step;
        const style = { color: '#ccc', weight: 1, dashArray: '4, 4' };

        for (let x = startX; x <= endX; x += step) {
            gridLayer.addLayer(L.polyline([[-startY, x], [-endY, x]], style));
            if (x >= gridBounds.minX && x <= gridBounds.maxX) gridLayer.addLayer(L.marker([-startY, x], { icon: L.divIcon({className: 'grid-label', html: x, iconAnchor: [0, -5], iconSize:[40,10]}) }));
        }
        for (let y = startY; y <= endY; y += step) {
            const ly = -y;
            gridLayer.addLayer(L.polyline([[ly, startX], [ly, endX]], style));
            if (y >= gridBounds.minY && y <= gridBounds.maxY) gridLayer.addLayer(L.marker([ly, startX], { icon: L.divIcon({className: 'grid-label', html: y, iconAnchor: [30, 0], iconSize:[40,10]}) }));
        }
    }
    drawGrid();
    map.on('zoomend', drawGrid);

    // ==========================================
    // ğŸ–¼ï¸ åœ°å½¢åº•åœ–é‚è¼¯ (å«æ ¡æ­£åŠŸèƒ½)
    // ==========================================
    let imgTopY = mapConfig.topY;
    let imgBottomY = mapConfig.bottomY;
    let imgLeftX = mapConfig.leftX;
    let imgRightX = mapConfig.rightX;

    let mapImageLayer = L.imageOverlay(mapConfig.imageUrl, [[-imgTopY, imgLeftX], [-imgBottomY, imgRightX]], {
        opacity: 0.9, 
        zIndex: -1 
    });
    mapImageLayer.addTo(map);

    if (mapConfig.calibrationMode) {
        const panel = document.getElementById('calibration-panel');
        panel.style.display = 'block';

        const inTop = document.getElementById('in-top');
        const inBottom = document.getElementById('in-bottom');
        const inLeft = document.getElementById('in-left');
        const inRight = document.getElementById('in-right');

        inTop.value = imgTopY;
        inBottom.value = imgBottomY;
        inLeft.value = imgLeftX;
        inRight.value = imgRightX;

        function updateImageBounds() {
            imgTopY = parseFloat(inTop.value);
            imgBottomY = parseFloat(inBottom.value);
            imgLeftX = parseFloat(inLeft.value);
            imgRightX = parseFloat(inRight.value);
            mapImageLayer.setBounds([[-imgTopY, imgLeftX], [-imgBottomY, imgRightX]]);
        }
        inTop.addEventListener('input', updateImageBounds);
        inBottom.addEventListener('input', updateImageBounds);
        inLeft.addEventListener('input', updateImageBounds);
        inRight.addEventListener('input', updateImageBounds);
    }

    // ä»‹é¢æ§åˆ¶
    const baseMaps = { "åœ°å½¢åœ–": mapImageLayer, "ç©ºç™½èƒŒæ™¯": L.layerGroup() };
    const overlayMaps = {
        "æ‘èŠé»ä½": villageLayer,
        "æ‘èŠåç¨± (å¯æ‹–æ›³)": labelLayer,
        "éµè·¯ (å·²é€šè»Š)": railwayLayer,
        "éµè·¯ (èˆˆå»ºä¸­)": railwayConstructionLayer,
        "å¼•å°ç·š": leaderLineLayer,
        "åæ¨™æ ¼ç·š": gridLayer
    };
    L.control.layers(baseMaps, overlayMaps, {collapsed: false}).addTo(map);
    
    if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });

    // åœ–ä¾‹
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'legend');
         L.DomEvent.disableScrollPropagation(div);
         L.DomEvent.disableClickPropagation(div);
        div.innerHTML = "<h4>åœ–ä¾‹</h4><small style='color:#666'>*å¯æ‹–æ›³åç¨±æ¨™ç±¤</small><br><br>";
        Object.keys(hierarchy).sort((a,b) => (countyHues[a] || 999) - (countyHues[b] || 999)).forEach(county => {
            const districts = Array.from(hierarchy[county]).sort();
            districts.forEach(dist => {
                const key = `${county}-${dist}`;
                
                let displayName;
                if (county === "æœªå®š") {
                    displayName = "æœªå®šè¡Œæ”¿å€";
                } else if (!dist || dist === "ç›´è½„") {
                    displayName = `${county}ç¸£ (ç›´è½„)`;
                } else {
                    displayName = `${county}ç¸£ ${dist}éƒ¡`;
                }

                div.innerHTML += `<div class="legend-item"><i class="legend-color" style="background:${districtColors[key]}"></i><span>${displayName}</span></div>`;
            });
        });
        div.innerHTML += "<hr style='margin:8px 0; border:0; border-top:1px solid #ccc'>";
        div.innerHTML += `<div class="legend-item"><span class="legend-line" style="background:#333"></span><span>éµè·¯ (å·²é€šè»Š)</span></div>`;
        div.innerHTML += `<div class="legend-item"><span class="legend-line" style="background:#e67e22; border-top: 3px dashed #e67e22; height:0; background:none;"></span><span>éµè·¯ (èˆˆå»ºä¸­)</span></div>`;
        return div;
    };
    legend.addTo(map);
</script>
</body>
</html>
