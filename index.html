<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘èŠåœ°åœ– - ç©©å®šä¿®å¾©ç‰ˆ v6.7</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; }
        #map { height: 100vh; width: 100vw; background: #eee; }
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px 15px; border-radius: 5px; border: 1px solid #bbb; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; max-height: 60vh; overflow-y: auto; }
        .legend h4 { margin: 0 0 8px 0; font-size: 15px; border-bottom: 2px solid #666; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color { width: 14px; height: 14px; margin-right: 8px; border-radius: 50%; border: 1px solid #666; flex-shrink: 0; }
        .changelog-btn { position: absolute; top: 80px; left: 10px; z-index: 1000; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; padding: 5px 10px; font-size: 13px; font-weight: bold; color: #333; text-decoration: none; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .version-badge { position: absolute; top: 120px; left: 10px; z-index: 1000; background: rgba(0, 0, 0, 0.7); color: #0f0; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-family: monospace; border: 1px solid rgba(0, 255, 0, 0.3); }
        .grid-label { font-size: 10px; color: #888; font-family: monospace; }
        .village-label-content { position: absolute; transform: translate(-50%, -50%); display: inline-block; font-size: 12px; font-weight: bold; background-color: rgba(255,255,255,0.95); padding: 3px 7px; border: 1px solid #666; border-radius: 4px; box-shadow: 1px 1px 4px rgba(0,0,0,0.2); pointer-events: auto; }
    </style>
</head>
<body>

<div id="map"></div>
<a href="changelog.html" target="_blank" class="changelog-btn">ğŸ“œ æ›´æ–°ç´€éŒ„</a>
<div id="version-display" class="version-badge">ç‰ˆæœ¬åµæ¸¬ä¸­...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<script src="data.js"></script>

<script>
    // --- [1] å®‰å…¨è®€å–è³‡æ–™ (é˜²æ­¢ undefined å ±éŒ¯å°è‡´è…³æœ¬ä¸­æ–·) ---
    var cfg = (typeof mapSettings !== 'undefined') ? mapSettings : { imageName: "map_bg.jpg", minX: -5000, maxX: 10000, minY: -10000, maxY: 1000 };
    var vData = (typeof rawData !== 'undefined') ? rawData : [];
    var hues = (typeof countyHues !== 'undefined') ? countyHues : {};
    var rwData = (typeof railwayRoutesData !== 'undefined') ? railwayRoutesData : { completed: [], construction: [] };

    // --- [2] åˆå§‹åŒ–åœ°åœ– ---
    var map = L.map('map', { 
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 4, zoomSnap: 0.1, attributionControl: false 
    });

    // --- [3] å®šç¾©åœ–å±¤çµ„ ---
    var blankLayer = L.layerGroup().addTo(map); 
    var villageLayer = L.layerGroup().addTo(map);
    var labelLayer = L.layerGroup().addTo(map); 
    var leaderLineLayer = L.layerGroup().addTo(map);
    var gridLayer = L.layerGroup().addTo(map);
    var railwayLayer = L.layerGroup().addTo(map);
    var railwayConstructionLayer = L.layerGroup();
    var mapImageLayer = L.imageOverlay(cfg.imageName, [[-cfg.minY, cfg.minX], [-cfg.maxY, cfg.maxX]], { opacity: 0.85 });

    // --- [4] è™•ç†è¡Œæ”¿å€é¡è‰²èˆ‡åº§æ¨™ç´¢å¼• ---
    var coordMap = {};
    var hierarchy = {};
    vData.forEach(function(v) {
        coordMap[v.name] = [-v.y, v.x];
        if (!hierarchy[v.prov]) hierarchy[v.prov] = {};
        if (!hierarchy[v.prov][v.county]) hierarchy[v.prov][v.county] = new Set();
        hierarchy[v.prov][v.county].add(v.dist || "ç›´è½„");
    });
    
    var districtColors = {};
    Object.keys(hierarchy).forEach(function(prov) {
        Object.keys(hierarchy[prov]).forEach(function(county) {
            var districts = Array.from(hierarchy[prov][county]).sort();
            var baseHue = (hues[county] !== undefined) ? hues[county] : 0;
            districts.forEach(function(dist, index) {
                var key = county + "-" + (dist || "ç›´è½„");
                var lightness = (districts.length > 1) ? (35 + (index / (districts.length - 1)) * 35) : 50;
                districtColors[key] = (county === "æœªå®š") ? "#7f8c8d" : "hsl(" + baseHue + ", 80%, " + lightness + "%)";
            });
        });
    });

    // --- [5] ç¹ªè£½éµè·¯ ---
    function drawLines(routes, style, layer) {
        if (!routes) return;
        routes.forEach(function(routeStr) {
            var stations = routeStr.split("-");
            var latLngs = [];
            stations.forEach(function(name) { if (coordMap[name]) latLngs.push(coordMap[name]); });
            if (latLngs.length > 1) L.polyline(latLngs, style).addTo(layer);
        });
    }
    drawLines(rwData.completed, { color: '#333', weight: 3, opacity: 0.7 }, railwayLayer);
    drawLines(rwData.construction, { color: '#e67e22', weight: 3, opacity: 0.7, dashArray: '5, 10' }, railwayConstructionLayer);

    // --- [6] ç¹ªè£½æ‘èŠæ¨™è¨˜èˆ‡æ¨™ç±¤ ---
    var labelObjects = [];
    var bounds = [];
    vData.forEach(function(v) {
        var latLng = [-v.y, v.x];
        bounds.push(latLng);
        var distKey = v.county + "-" + (v.dist || "ç›´è½„");
        var color = districtColors[distKey] || "#333";
        
        var popupHtml = "<strong>" + v.name + "</strong><br>" + v.prov + "çœ " + v.county + "ç¸£<br>åº§æ¨™: (" + v.x + ", " + v.y + ")";
        L.circleMarker(latLng, { radius: 5, fillColor: color, color: "#000", weight: 1.5, fillOpacity: 1 }).bindPopup(popupHtml).addTo(villageLayer);

        var line = L.polyline([latLng, latLng], { color: '#666', weight: 1, opacity: 0 }).addTo(leaderLineLayer);
        var label = L.marker(latLng, {
            icon: L.divIcon({ className: 'village-label-wrapper', html: '<div class="village-label-content">' + v.name + '</div>', iconSize: [0, 0] }),
            draggable: true
        }).bindPopup(popupHtml).addTo(labelLayer);
        
        label.on('drag', function(e) {
            line.setLatLngs([latLng, e.target.getLatLng()]);
            line.setStyle({opacity: 0.5});
            label.isManualMoved = true;
        });
        labelObjects.push({ marker: label, line: line, origin: latLng });
    });

    // --- [7] æ¨™ç±¤é¿è®“èˆ‡æ ¼ç·šç¹ªè£½ ---
    function updateLabels() {
        var currentBounds = map.getBounds();
        var visible = [];
        labelObjects.forEach(function(o) {
            if (!o.marker.isManualMoved) o.marker.setLatLng(o.origin);
            if (currentBounds.contains(o.origin)) {
                var pt = map.latLngToContainerPoint(o.origin);
                visible.push({ obj: o, x: pt.x, y: pt.y, ox: pt.x, oy: pt.y });
            }
        });
        for (var k = 0; k < 10; k++) {
            visible.forEach(function(a) {
                if (a.obj.marker.isManualMoved) return;
                if (Math.sqrt(Math.pow(a.x-a.ox,2)+Math.pow(a.y-a.oy,2)) < 30) a.y -= 2;
                visible.forEach(function(b) {
                    if (a === b) return;
                    var dx = a.x - b.x, dy = a.y - b.y, d = Math.sqrt(dx*dx + dy*dy);
                    if (d < 45 && d > 0) { a.x += (dx/d)*2; a.y += (dy/d)*2; }
                });
            });
        }
        visible.forEach(function(item) {
            var newLL = map.containerPointToLatLng([item.x, item.y]);
            if (!item.obj.marker.isManualMoved) item.obj.marker.setLatLng(newLL);
            var pxDist = map.latLngToContainerPoint(item.obj.marker.getLatLng()).distanceTo([item.ox, item.oy]);
            item.obj.line.setStyle({ opacity: (pxDist > 12 ? 0.5 : 0) });
            if (pxDist > 12) item.obj.line.setLatLngs([item.obj.origin, item.obj.marker.getLatLng()]);
        });
    }

    function drawGrid() {
        gridLayer.clearLayers();
        var z = map.getZoom();
        var step = z >= 1 ? 100 : (z >= -1 ? 500 : 1000);
        var b = { minX: cfg.minX - 2000, maxX: cfg.maxX + 2000, minY: cfg.minY - 2000, maxY: cfg.maxY + 2000 };
        for (var x = Math.floor(b.minX / step) * step; x <= b.maxX; x += step) {
            L.polyline([[-b.minY, x], [-b.maxY, x]], { color: '#ccc', weight: 1, dashArray: '4,4', opacity: 0.5 }).addTo(gridLayer);
            L.marker([-b.minY, x], { icon: L.divIcon({ className: 'grid-label', html: x, iconAnchor: [0, 15] }), interactive: false }).addTo(gridLayer);
        }
        for (var y = Math.floor(b.minY / step) * step; y <= b.maxY; y += step) {
            L.polyline([[-y, b.minX], [-y, b.maxX]], { color: '#ccc', weight: 1, dashArray: '4,4', opacity: 0.5 }).addTo(gridLayer);
            L.marker([-y, b.minX], { icon: L.divIcon({ className: 'grid-label', html: y, iconAnchor: [45, 5] }), interactive: false }).addTo(gridLayer);
        }
    }

    // --- [8] åˆå§‹åŒ–æ§åˆ¶ã€åœ–ä¾‹èˆ‡äº‹ä»¶ ---
    L.control.layers({ "ç©ºç™½èƒŒæ™¯": blankLayer, "åœ°å½¢åœ–": mapImageLayer }, { "æ‘èŠé»ä½": villageLayer, "åç¨±æ¨™ç±¤": labelLayer, "æ ¼ç·š": gridLayer, "éµè·¯ (å·²é€šè»Š)": railwayLayer, "éµè·¯ (èˆˆå»ºä¸­)": railwayConstructionLayer }, { collapsed: false }).addTo(map);

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = "<h4>ğŸ—ºï¸ è¡Œæ”¿å€åŠƒ</h4>";
        Object.keys(hierarchy).forEach(function(prov) {
            div.innerHTML += '<div style="font-weight:bold; color:#d35400; margin-top:5px;">' + prov + 'çœ</div>';
            Object.keys(hierarchy[prov]).forEach(function(county) {
                Array.from(hierarchy[prov][county]).forEach(function(dist) {
                    var color = districtColors[county + "-" + (dist || "ç›´è½„")];
                    div.innerHTML += '<div class="legend-item"><i class="legend-color" style="background:' + color + '"></i>' + county + 'ç¸£ ' + (dist === 'ç›´è½„' ? '(ç›´è½„)' : dist + 'éƒ¡') + '</div>';
                });
            });
        });
        return div;
    };
    legend.addTo(map);

    map.on('zoomend moveend', updateLabels);
    map.on('zoomend', drawGrid);
    map.whenReady(function() {
        drawGrid(); updateLabels();
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
    });

    // --- [9] ç¨ç«‹åŸ·è¡Œ GitHub ç‰ˆæœ¬æ›´æ–° (æ”¾åœ¨æœ€å¾Œï¼Œä¸”å®Œå…¨éš”é›¢) ---
    (async function() {
        try {
            var host = window.location.hostname;
            if (host.includes('github.io')) {
                var user = host.split('.')[0];
                var repo = window.location.pathname.split('/')[1] || "";
                var res = await fetch('https://api.github.com/repos/' + user + '/' + repo + '/commits?per_page=1');
                if (res.ok) {
                    var data = await res.json();
                    var date = new Date(data[0].commit.committer.date);
                    document.getElementById('version-display').innerText = "æœ€å¾Œæ›´æ–°: " + date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false });
                    return;
                }
            }
            document.getElementById('version-display').innerText = "æœ¬åœ°æ¸¬è©¦æ¨¡å¼";
        } catch (e) { document.getElementById('version-display').innerText = "ç‰ˆæœ¬è³‡è¨Šè®€å–å¤±æ•—"; }
    })();
</script>
</body>
</html>
