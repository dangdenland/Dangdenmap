<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>村莊地圖</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        #map { height: 100vh; width: 100vw; background-color: #f5f5f5; }
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px 15px; border-radius: 5px; border: 1px solid #bbb; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; max-height: 400px; overflow-y: auto; line-height: 1.5; }
        .legend h4 { margin: 0 0 8px 0; font-size: 15px; border-bottom: 2px solid #666; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color { width: 16px; height: 16px; margin-right: 8px; border-radius: 50%; border: 1px solid #666; flex-shrink: 0; }
        .legend-line { width: 20px; height: 3px; margin-right: 8px; display: inline-block; vertical-align: middle; }
        .grid-label { font-size: 10px; color: #999; white-space: nowrap; }
        .village-label-wrapper { background: transparent; border: none; }
        .village-label-content { position: absolute; left: 0; top: 0; transform: translate(-50%, -50%); display: inline-block; width: max-content; min-width: 40px; box-sizing: border-box; font-size: 12px; font-weight: bold; color: #000; background-color: #fff; padding: 4px 8px; border: 1px solid #666; border-radius: 4px; white-space: nowrap; text-align: center; box-shadow: 1px 1px 4px rgba(0,0,0,0.2); cursor: move; z-index: 10; user-select: none; -webkit-user-select: none; }
        .village-label-content:hover { background-color: #f0f8ff; border-color: #007bff; z-index: 20; }
        .leaflet-popup-content { font-size: 14px; line-height: 1.6; }
        @media print { .leaflet-control-container .leaflet-top, .leaflet-control-container .leaflet-left, .leaflet-control-zoom, .leaflet-control-layers { display: none !important; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .legend { position: absolute; bottom: 20px; right: 20px; box-shadow: none; border: 1px solid #000; } #map { height: 100%; width: 100%; } }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- 引入外部資料 -->
<script src="map-data.js"></script> 

<script>
    // 檢查資料
    if (typeof rawData === 'undefined' || typeof railwayRoutesData === 'undefined') {
        alert("錯誤：找不到 map-data.js 資料檔，或檔案格式有誤。");
    }

    const coordMap = {};
    [...rawData, ...extraStations].forEach(v => {
        coordMap[v.name] = [-v.y, v.x]; 
    });

    const map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -6, maxZoom: 3, zoomSnap: 0.5, attributionControl: false
    });

    // 顏色邏輯
    const countyHues = { "南安": 0, "雪川": 210, "外埔": 120, "舟山": 270, "港南": 35 };
    const hierarchy = {};
    rawData.forEach(v => {
        if (!hierarchy[v.county]) hierarchy[v.county] = new Set();
        hierarchy[v.county].add(v.dist || "直轄");
    });
    const districtColors = {}; 
    Object.keys(hierarchy).forEach(county => {
        const districts = Array.from(hierarchy[county]).sort();
        const baseHue = countyHues[county] !== undefined ? countyHues[county] : 0;
        districts.forEach((dist, index) => {
            const count = districts.length;
            let lightness = 50;
            if (count > 1) lightness = 35 + (index / (count - 1)) * 35; 
            districtColors[`${county}-${dist}`] = `hsl(${baseHue}, 80%, ${lightness}%)`;
        });
    });

    // 圖層
    const villageLayer = L.layerGroup();
    const labelLayer = L.layerGroup(); 
    const leaderLineLayer = L.layerGroup
